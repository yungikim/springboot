/* kmslab_editor 1.0.05 */

"use strict";function History(a){this.initialize(a)}function TextTools(a){this.initialize(a)}function ResizeTools(a){this.initialize(a)}function ShapeTools(a){this.initialize(a)}function DrawTools(a){this.initialize(a)}function CropTools(a){this.initialize(a)}!function(a){a.fn.disableSelection=function(){return this.on("selectstart",!1)}}(jQuery),function(){function _init(){_imgEdit=new ImageEditor,_bindBtnEvent(),_bindDrop(),_bindPaste(),_initSelectorEvent(),_initCropEvent(),_initRotateEvent(),__initResizeEvent(),_initTextEvent(),_initShapeEvent(),_initDrawEvent(),$(window).on("resize",function(){this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},200)}),$(window).on("resizeEnd",function(){_imgEdit.eventWindowResize()}),$("select").selectbox()}function _navClick(a,b){if(!b||!$(b).hasClass("on")){for(var c in _imgEdit.tools)_imgEdit.tools[c].removeHandler(function(){_navClick(a,b)});a&&_imgEdit.tools[a]&&_imgEdit.tools[a].createHandler(),$("nav:eq(0)").find(".on").removeClass("on"),b&&$(b).addClass("on"),b&&(_imgEdit.status.activeMenu=a),b||_navClick("selector",$(".btn_selector"))}}function _navMenuClick(a,b){$(".contents nav .detail_menu").hide(),$(".contents nav em.btn_sub.on").removeClass("on"),a&&$(".contents nav ."+a+"_menu").show(),b&&$(b).addClass("on")}function deleteObjects(){var a=_imgEdit.canvas,b=a.getActiveObjects();b&&(a.discardActiveObject(),b.forEach(function(b){a.remove(b)}),_imgEdit.history.add().save())}function _initSelectorEvent(){var a=$(".btn_selector");a.attr("title",Trex._I18N.g("image_editor.selection_tool","선택 도구")),a.on("click",function(b){_navMenuClick(null,null),_navClick("selector",a),_imgEdit.canvas.discardActiveObject().renderAll(),_imgEdit.canvas.selectable=!0}),$(document.body).on("keydown",function(a){46==a.keyCode&&"selector"==_imgEdit.status.activeMenu&&deleteObjects()})}function _initCropEvent(){_imgEdit.tools.crop=new CropTools({main:_imgEdit,styleEl:{image:$("#crop_background_img"),selector:$("#canvas_crop_wrap .crop_selector_wrap")}});var a=$(".btn_crop");a.attr("title",Trex._I18N.g("image_editor.crop_tool","자르기 도구")),a.on("click",function(b){_navMenuClick(null,null),_navClick("crop",a),b.stopPropagation(),b.preventDefault()})}function _initRotateEvent(){var a=$(".btn_rotate");a.attr("title",Trex._I18N.g("image_editor.rotate_tool","회전 도구"));var b=$(".btn_rotate_sub");a.on("click",function(a){_navMenuClick(null,null),_navClick(null,null),__canvasRotation(!0)}),b.on("click",function(c){$(this).hasClass("disabled")||($(this).hasClass("on")?(_navClick(null,null),_navMenuClick(null,null)):(_navClick("rotate",a),_navMenuClick("rotate",b)),c.stopPropagation(),c.preventDefault())}),$(".btn_left_rotate").on("click",function(){__canvasRotation(!1)}),$(".btn_right_rotate").on("click",function(){__canvasRotation(!0)})}function __canvasRotation(a){var b=a?90:-90,c=_imgEdit.img.angle;_imgEdit.history.save(),c<0&&(c=360+c);var d=(Math.round(Math.abs(c))+b)%360;_imgEdit.status.angle=d,_imgEdit.canvas.discardActiveObject();var e=new fabric.Group;_imgEdit.canvas.getObjects().map(function(a){e.addWithUpdate(a)}),_imgEdit.canvas.add(e),e.rotate(b),e.setCoords(),_imgEdit.canvas.setActiveObject(e).renderAll();var f=e.getBoundingRect();_imgEdit.setCanvasSize(f.width,f.height),_imgEdit.canvas.centerObject(e),e.setCoords(),_imgEdit.canvas.setActiveObject(e).renderAll(),_imgEdit.canvas.discardActiveObject();var g=e.getObjects();e.remove(g),_imgEdit.canvas.remove(e),e.destroy(),_imgEdit.canvas.renderAll(),_imgEdit.history.add(!0,function(a,b,c){return function(){_imgEdit.img=_imgEdit.canvas.item(0),_imgEdit.status.angle=a,_imgEdit.setCanvasSize(b,c)}}(d,f.width,f.height)).save()}function __initResizeEvent(){_imgEdit.tools.resize=new ResizeTools({main:_imgEdit,styleEl:{width:$(".resize_menu #reize_width"),height:$(".resize_menu #reize_height"),ratio:$(".resize_menu .btn_ratio"),origin:$(".resize_menu .btn_original")}});var a=$(".btn_resize");a.attr("title",Trex._I18N.g("image_editor.resize_tool","크기조정 도구")),$(".resize_menu .btn_ratio").attr("title",Trex._I18N.g("image_editor.resize_tool_ratio","비율유지"));var b=$(".btn_resize_sub");a.on("click",function(b){_navMenuClick(null,null),_navClick("resize",a),b.stopPropagation(),b.preventDefault()}),b.on("click",function(c){$(this).hasClass("disabled")||($(this).hasClass("on")?_navMenuClick(null,null):(_navClick("resize",a),_navMenuClick("resize",b)),c.stopPropagation(),c.preventDefault())})}function _initTextEvent(){_imgEdit.tools.text=new TextTools({main:_imgEdit,styleEl:{font:$(".text_menu #sel_font").attr("title",Trex._I18N.g("image_editor.type_tool_font","글꼴")),size:$(".text_menu #sel_size").attr("title",Trex._I18N.g("image_editor.type_tool_size","글자크기")),bold:$(".text_menu .btn_bold").attr("title",Trex._I18N.g("image_editor.type_tool_bold","굵게")),italic:$(".text_menu .btn_italic").attr("title",Trex._I18N.g("image_editor.type_tool_italic","기울임")),underline:$(".text_menu .btn_underline").attr("title",Trex._I18N.g("image_editor.type_tool_underline","밑줄")),color:$(".text_menu .btn_txt_color").attr("title",Trex._I18N.g("image_editor.type_tool_forecolor","글자색")),bg_color:$(".text_menu .btn_bg_color").attr("title",Trex._I18N.g("image_editor.type_tool_backcolor","글자 배경색"))}});var a=$(".btn_text");a.attr("title",Trex._I18N.g("image_editor.type_tool","문자 도구"));var b=$(".btn_text_sub");a.on("click",function(b){_navMenuClick(null,null),_navClick("text",a)}),b.on("click",function(c){$(this).hasClass("disabled")||($(this).hasClass("on")?_navMenuClick(null,null):(_navClick("text",a),_navMenuClick("text",b)),c.stopPropagation(),c.preventDefault())})}function _initShapeEvent(){_imgEdit.tools.shape=new ShapeTools({main:_imgEdit,styleEl:{main:$(".btn_shape"),rect:$(".shape_menu .btn_rect").attr("title",Trex._I18N.g("image_editor.ractangle_tool","사각형 도구")),round_rect:$(".shape_menu .btn_round_rect").attr("title",Trex._I18N.g("image_editor.rounded_ractangle_tool","둥근 사각형 도구")),circle:$(".shape_menu .btn_circle").attr("title",Trex._I18N.g("image_editor.ellipse_tool","타원 도구")),line:$(".shape_menu .btn_line").attr("title",Trex._I18N.g("image_editor.line_tool","라인 도구")),bg_color:$(".shape_menu .btn_shape_bg_color").attr("title",Trex._I18N.g("image_editor.background_color","배경색")),bg_color_span:$(".shape_menu #btn_shape_bg_color_span"),size:$(".shape_menu .select.s_size"),style:$(".shape_menu .select.s_style"),line_color:$(".shape_menu .btn_shape_line_color").attr("title",Trex._I18N.g("image_editor.border_color","선 색")),line_color_span:$(".shape_menu #btn_shape_line_color_span")}});var a=$(".btn_shape");a.attr("title",Trex._I18N.g("image_editor.ractangle_tool","사각형 도구"));var b=$(".btn_shape_sub");a.on("click",function(b){_navMenuClick(null,null),_navClick("shape",a)}),b.on("click",function(c){$(this).hasClass("disabled")||($(this).hasClass("on")?_navMenuClick(null,null):(_navClick("shape",a),_navMenuClick("shape",b)),c.stopPropagation(),c.preventDefault())})}function _initDrawEvent(){_imgEdit.tools.draw=new DrawTools({main:_imgEdit,styleEl:{main:$(".btn_draw"),pencil:$(".draw_menu .btn_pencil").attr("title",Trex._I18N.g("image_editor.pencil_tool","연필 도구")),pen:$(".draw_menu .btn_pen").attr("title",Trex._I18N.g("image_editor.marker_tool","마커 도구")),brush:$(".draw_menu .btn_brush").attr("title",Trex._I18N.g("image_editor.crayon_tool","크레용 도구")),color:$(".draw_menu .btn_color").attr("title",Trex._I18N.g("image_editor.draw_color","색상")),color_span:$(".draw_menu #draw_span_color"),brush_size:$(".draw_menu .brush_size"),wrap_size:$(".draw_menu .wrap_size"),size_drag:$(".draw_menu .btn_drag"),size_input:$(".draw_menu #draw_brush_size"),size_text:$(".draw_menu #size_text"),drag_objs:$(".draw_menu .wrap_size, .draw_menu #size_text, .draw_menu .btn_drag")}});var a=$(".btn_draw");a.attr("title",Trex._I18N.g("image_editor.pencil_tool","연필 도구"));var b=$(".btn_draw_sub");a.on("click",function(b){_navMenuClick(null,null),_navClick("draw",a)}),b.on("click",function(c){$(this).hasClass("disabled")||($(this).hasClass("on")?_navMenuClick(null,null):(_navClick("draw",a),_navMenuClick("draw",b)),c.stopPropagation(),c.preventDefault())})}function _bindBtnEvent(){$(".btn_image").on("click",function(){$("#imagefile").click()}),$("#default_canvas").on("dblclick",function(){$("#imgfile").click()}),$(".btn_pc").on("click",function(){_save_image()}),$(".btn_insert").on("click",function(){_insert_editor_body()}),$("#imgfile").on("change",function(){image_load(this.files)})}function _bindDrop(){$(window.document).on("dragover",function(a){var b;b=a.originalEvent,b.stopPropagation(),b.preventDefault()}),$(window.document).on("dragenter",function(a){var b;b=a.originalEvent,b.stopPropagation(),b.preventDefault()}),$(window.document).on("dragleave",function(a){var b;b=a.originalEvent,b.stopPropagation(),b.preventDefault()}),$(window.document).on("drop",function(a){var b;b=a.originalEvent,b.stopPropagation(),b.preventDefault();var c=b.dataTransfer&&b.dataTransfer.files;c&&image_load(c)})}function _bindPaste(){function _getImageFile(ev){var clip,len,file=null;if(clip=ev.clipboardData,clip&&clip.items&&(len=clip.items.length),void 0!==clip&&len>0)for(var g=0;g<len;g++){var item=clip.items[g];if(item.type.indexOf("image")>-1){file=item.getAsFile();break}}else if(clip=window.clipboardData,clip&&clip.files&&(len=clip.files.length),void 0!==clip&&len>0)for(var g=0;g<len;g++){var item=clip.files[g];if(item.type.indexOf("image")>-1){file=item;break}}else if(isIE&&window.ImageUploader){var data=window.ImageUploader.getClipboardData();if(!data)return!1;var json=null;try{json=eval("("+data+")")}catch(a){return!1}if("multi"==json.type&&json.data.html&&json.data.image){var _html=json.data.html;-1!=_html.search(/urn\:schemas\-microsoft\-com\:office\:word/i)&&(json.data.image=null)}if("image"==json.type||"multi"==json.type&&json.data.image){var _data="multi"==json.type?json.data.image:json.data;return file=_data[0].dataURL,_createImgObject(file),!0}}if(file){var render=new FileReader;return render.onload=function(a){_createImgObject(a.target.result)},render.readAsDataURL(file),!0}return!1}if(isIE){var _pateEl=$(".ie_paste");$(document.body).on("keydown",function(a){var b=a.originalEvent;86==b.keyCode&&b.ctrlKey&&_pateEl.focus()}),_pateEl.on("paste",function(a){if(_getImageFile(a.originalEvent))return a.stopPropagation(),a.preventDefault(),!1})}else $(document.body).on("paste",function(a){if(_getImageFile(a.originalEvent))return a.stopPropagation(),a.preventDefault(),!1})}function base64ToBlob(a,b,c){b=b||"",c=c||512;for(var d=atob(a),e=[],f=0;f<d.length;f+=c){for(var g=d.slice(f,f+c),h=new Array(g.length),i=0;i<g.length;i++)h[i]=g.charCodeAt(i);var j=new Uint8Array(h);e.push(j)}return new Blob(e,{type:b})}function _save_image(){_navMenuClick(null,null),_navClick(null,null);var a=_imgEdit.canvas.toDataURL("png"),b=a.substring(0,a.indexOf(",")),c=a.substring(a.indexOf(",")+1),d=b.split(":")[1].split(";")[0],e=base64ToBlob(c,d);saveAs(e,"imageeditor_"+(new Date).getTime().toString(16)+".png")}function _insert_editor_body(){if(_imgEdit.tools.crop&&_imgEdit.tools.crop.activeTools)return void _imgEdit.tools.crop.removeHandler(function(){_insert_editor_body()});_navMenuClick(null,null),_navClick(null,null);var a=_imgEdit.canvas.toDataURL("png");if(Trex._TI&&Trex._TI.img){Trex._TI.img.src=a,Trex._TI.img.width=_imgEdit.canvas.getWidth(),Trex._TI.img.height=_imgEdit.canvas.getHeight(),Trex._TI.img.style.width=_imgEdit.canvas.getWidth()+"px",Trex._TI.img.style.height=_imgEdit.canvas.getHeight()+"px";try{Trex.KEditor&&Trex.KEditor.editor.getCanvas().history.saveHistory()}catch(a){}closeWindow()}else{var b={imageurl:a,filename:"imageeditor_"+(new Date).getTime().toString(16)+".png",filesize:10,imagealign:"L",originalurl:a,thumburl:a};done(b)}}function _btnEnabled(a){$(".btn_insert, .btn_pc, .btn_selector, .btn_crop, .btn_rotate, .btn_resize, .btn_text, .btn_shape, .btn_draw")[a?"removeClass":"addClass"]("disabled")[a?"removeAttr":"attr"]("disabled","disabled").removeClass("on"),$("nav .btn_sub")[a?"removeClass":"addClass"]("disabled"),a&&$(".btn_selector").addClass("on")}function _createImgObject(a,b,c,d){$("#canvas_wrap").width(),$("#canvas_wrap").height();IMAGE=new Image;var e=$.extend({},DEF_OPT,{sizeType:"original"});IMAGE.onload=function(){_navClick(null,null),_navMenuClick(null,null),_imgEdit.img=new fabric.Image(IMAGE,e),_imgEdit.canvas.clear(),_imgEdit.originImgInfo={width:IMAGE.width,height:IMAGE.height},_imgEdit.canvas.setDimensions({width:IMAGE.width,height:IMAGE.height}),_imgEdit.canvas.add(_imgEdit.img).setActiveObject(_imgEdit.img),_imgEdit.img.set("selectable",!1),c&&(c.width&&(_imgEdit.img.scaleX=c.width/IMAGE.width),c.height&&(_imgEdit.img.scaleY=c.height/IMAGE.height),_imgEdit.img.setCoords(),_imgEdit.canvas.setDimensions({width:c.width,height:c.height})),_imgEdit.canvas.discardActiveObject().renderAll(),!0!==b?_imgEdit.history.add(!1,function(a,b,c){return function(){_imgEdit.img=new fabric.Image(a,b),_imgEdit.canvas.clear(),_imgEdit.originImgInfo={width:a.width,height:a.height},_imgEdit.canvas.setDimensions({width:a.width,height:a.height}),_imgEdit.canvas.add(_imgEdit.img).setActiveObject(_imgEdit.img),_imgEdit.img.set("selectable",!1),c&&(c.width&&(_imgEdit.img.scaleX=c.width/a.width),c.height&&(_imgEdit.img.scaleY=c.height/a.height),_imgEdit.img.setCoords(),_imgEdit.canvas.setDimensions({width:c.width,height:c.height})),_imgEdit.canvas.discardActiveObject().renderAll(),_imgEdit.showPanel("canvas")}}(IMAGE,e,c)).save():_imgEdit.history.defaultStatus(!1,function(a,b,c){return function(){_imgEdit.img=new fabric.Image(a,b),_imgEdit.canvas.clear(),_imgEdit.originImgInfo={width:a.width,height:a.height},_imgEdit.canvas.setDimensions({width:a.width,height:a.height}),_imgEdit.canvas.add(_imgEdit.img).setActiveObject(_imgEdit.img),_imgEdit.img.set("selectable",!1),c&&(c.width&&(_imgEdit.img.scaleX=c.width/a.width),c.height&&(_imgEdit.img.scaleY=c.height/a.height),_imgEdit.img.setCoords(),_imgEdit.canvas.setDimensions({width:c.width,height:c.height})),_imgEdit.canvas.discardActiveObject().renderAll(),_imgEdit.showPanel("canvas")}}(IMAGE,e,c)),_imgEdit.showPanel("canvas"),d&&d()},IMAGE.src=a}function image_load(a){var b=a[0];document.getElementById("imgfile").value;if(!b.type.match(/image.*/))return void alert(Trex._I18N.g("image_editor.alert_not_image","이미지 파일이 아닙니다"));var c=new FileReader;c.onload=function(a){_createImgObject(a.target.result)},c.readAsDataURL(b)}var IMAGE,_ua=navigator.userAgent,isIE=-1!=_ua.search(/Trident/i),isChrome=!isIE&&-1!=_ua.search(/Chrome/i),DEF_OPT={transparentCorners:!1,hoverCursor:"default",cornerColor:"rgb(255,255,255)",cornerSize:8,centeredScaling:!0,hasRotatingPoint:!1,hasBorders:!1,minScaleLimit:.1,lockScalingFlip:!0,selectable:!1,sizeType:"original"},_imgEdit=null,ImageEditor=function(){var a=this;fabric.devicePixelRatio=1,fabric.StaticCanvas.prototype._setImageSmoothing=function(){var a=this.getContext();void 0!==a.imageSmoothingEnabled?a.imageSmoothingEnabled=this.imageSmoothingEnabled:void 0!==a.webkitImageSmoothingEnabled?a.webkitImageSmoothingEnabled=this.imageSmoothingEnabled:void 0!==a.mozImageSmoothingEnabled?a.mozImageSmoothingEnabled=this.imageSmoothingEnabled:void 0!==a.msImageSmoothingEnabled?a.msImageSmoothingEnabled=this.imageSmoothingEnabled:void 0!==a.oImageSmoothingEnabled&&(a.oImageSmoothingEnabled=this.imageSmoothingEnabled)},fabric.IText.prototype.setCustomImageSmoothing=this.setImageSmoothing,fabric.IText.prototype._CustomRender=fabric.IText.prototype.render,fabric.IText.prototype.render=function(a){this.setCustomImageSmoothing(a,0!=this.angle),this._CustomRender(a),this.setCustomImageSmoothing(a)},isIE&&(fabric.IText.prototype.initMousedownHandler=function(){this.on("mousedown",function(a){if(this.editable&&(!a.e.button||1===a.e.button)){this.inCompositionMode&&this.onCompositionEnd();var b=this.canvas.getPointer(a.e);this.__mousedownX=b.x,this.__mousedownY=b.y,this.__isMousedown=!0,this.selected&&this.setCursorByClick(a.e),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection())}})}),this.paste_wrap=$("#default_canvas"),this.canvas_wrap=$("#canvas_wrap"),this.crop_wrap=$("#canvas_crop_wrap"),this.canvas=new fabric.Canvas("canvas_image"),this.crop_canvas=new fabric.Canvas("canvas_crop_image"),this.defaultImageSmoothing=this.canvas.imageSmoothingEnabled,this.img=null,this.tools={},this.status={angle:0,canvas_fullsize_mode:!1,activeMenu:""},fabric.Object.prototype.set({transparentCorners:!1,cornerColor:"rgba(255,255,255,1)",cornerStrokeColor:"rgba(102,153,255,0.5)",cornerSize:7}),this.originImgInfo=null,this.wrap=$("#canvas_wrap"),this.history=new History({main:this,styleEl:{prev:$(".btn_prev").attr("title",Trex._I18N.g("image_editor.undo","실행취소")),next:$(".btn_next").attr("title",Trex._I18N.g("image_editor.redo","다시실행"))},undoEvent:function(){return!a.tools.crop||!a.tools.crop.activeTools||(a.menuClear(),!1)},startHistory:1}),this.canvas.on("object:modified",function(){a.history.add().save()}),this.canvas.on("path:created",function(){a.history.add().save()}),Trex._TI&&_createImgObject(Trex._TI.src,!0,{width:Trex._TI.width,height:Trex._TI.height})};ImageEditor.prototype={setCanvasSize:function(a,b){a&&b?(this.wrap.css("padding","10px"),this.canvas.setDimensions({width:a,height:b})):(this.wrap.css("padding","0"),this.wrap.css("overflow","hidden"),this.canvas.setDimensions({width:this.wrap.width(),height:this.wrap.height()}),this.wrap.css("overflow","auto"))},setCropCanvasSize:function(){this.crop_canvas.setDimensions({width:this.crop_wrap.width(),height:this.crop_wrap.height()}),this.tools.crop&&this.tools.crop.resize()},eventWindowResize:function(){this.setCropCanvasSize(),!0===this.status.canvas_fullsize_mode&&this.setCanvasSize()},merge:function(){_createImgObject(this.canvas.toDataURL("png"))},loadData:function(a,b){_createImgObject(a,null,null,b)},menuClear:function(){_navMenuClick(null,null),_navClick(null,null)},btnEnabled:function(a){_btnEnabled(a)},setImageSmoothing:function(a,b){void 0!==a.imageSmoothingEnabled?a.imageSmoothingEnabled=null!==b?b:this.defaultImageSmoothing:void 0!==a.webkitImageSmoothingEnabled?a.webkitImageSmoothingEnabled=null!==b?b:this.defaultImageSmoothing:void 0!==a.mozImageSmoothingEnabled?a.mozImageSmoothingEnabled=null!==b?b:this.defaultImageSmoothing:void 0!==a.msImageSmoothingEnabled?a.msImageSmoothingEnabled=null!==b?b:this.defaultImageSmoothing:void 0!==a.oImageSmoothingEnabled&&(a.oImageSmoothingEnabled=null!==b?b:this.defaultImageSmoothing)},showPanel:function(a){this.paste_wrap["paste"==a?"show":"hide"](),this.canvas_wrap["canvas"==a?"show":"hide"](),this.crop_wrap["crop"==a?"show":"hide"](),_btnEnabled("paste"!=a)}},window.imageEditorInit=function(){_init()}}();var saveAs=saveAs||function(a){if(!(void 0===a||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=b.createElementNS("http://www.w3.org/1999/xhtml","a"),e="download"in d,f=function(a){var b=new MouseEvent("click");a.dispatchEvent(b)},g=/constructor/i.test(a.HTMLElement)||a.safari,h=/CriOS\/[\d]+/.test(navigator.userAgent),i=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},j=function(a){var b=function(){"string"==typeof a?c().revokeObjectURL(a):a.remove()};setTimeout(b,4e4)},k=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(a){i(a)}}},l=function(a){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob([String.fromCharCode(65279),a],{type:a.type}):a},m=function(b,i,m){m||(b=l(b));var n,o=this,p=b.type,q="application/octet-stream"===p,r=function(){k(o,"writestart progress write writeend".split(" "))};if(o.readyState=o.INIT,e)return n=c().createObjectURL(b),void setTimeout(function(){d.href=n,d.download=i,f(d),r(),j(n),o.readyState=o.DONE});!function(){if((h||q&&g)&&a.FileReader){var d=new FileReader;return d.onloadend=function(){var b=h?d.result:d.result.replace(/^data:[^;]*;/,"data:attachment/file;");a.open(b,"_blank")||(a.location.href=b),b=void 0,o.readyState=o.DONE,r()},d.readAsDataURL(b),void(o.readyState=o.INIT)}if(n||(n=c().createObjectURL(b)),q)a.location.href=n;else{a.open(n,"_blank")||(a.location.href=n)}o.readyState=o.DONE,r(),j(n)}()},n=m.prototype,o=function(a,b,c){return new m(a,b||a.name||"download",c)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(a,b,c){return b=b||a.name||"download",c||(a=l(a)),navigator.msSaveOrOpenBlob(a,b)}:(n.abort=function(){},n.readyState=n.INIT=0,n.WRITING=1,n.DONE=2,n.error=n.onwritestart=n.onprogress=n.onwrite=n.onabort=n.onerror=n.onwriteend=null,o)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);History.prototype={initialize:function(a){var b=this,c=a||{};this.main=c.main,this.undoEvent=c.undoEvent||null,this.redoEvent=c.redoEvent||null,this.styleEl=c.styleEl||{},this.MAX_HISTORY=c&&c.MAX?c.MAX:50,this.bold=!1,this._default=null,this._undo=[],this._redo=[],this._cache=[],this.canvas=this.main.canvas,this.prev=this.styleEl.prev,this.next=this.styleEl.next,this._lock=!1,this._eventLock=!1,this.prev.on("click",function(){b.undo()}),this.next.on("click",function(){b.redo()}),this.historyOverflow=!1},add:function(a,b){return this._lock||this._eventLock?this:(this._cache.push({json:!1!==a?this.canvas.toJSON(["selectable","transparentCorners","hoverCursor","cornerColor","cornerSize","centeredScaling","hasRotatingPoint","hasBorders","minScaleLimit","lockScalingFlip","sizeType"]):null,fn:b,w:this.canvas.getWidth(),h:this.canvas.getHeight()}),this)},defaultStatus:function(a,b){this._default={json:!1!==a?this.canvas.toJSON(["selectable","transparentCorners","hoverCursor","cornerColor","cornerSize","centeredScaling","hasRotatingPoint","hasBorders","minScaleLimit","lockScalingFlip","sizeType"]):null,fn:b,w:this.canvas.getWidth(),h:this.canvas.getHeight()}},save:function(){if(this._lock||this._eventLock)return this;if(this._cache.length>0){if(this._undo=this._undo.concat(this._cache),this._undo.length>this.MAX_HISTORY){this.historyOverflow=!0;for(var a=this._undo.splice(0,this._undo.length-this.MAX_HISTORY),b=0;b<a.length;b++)a[b].json="",a[b].fn=""}this.emptyCache(),this._redo=[]}return this.updateState(),this},undo:function(){if(this._lock)return this;if(this.undoEvent&&!this.undoEvent())return this;this.main.menuClear(),this.save(),this._lock=!0;var a=this._undo.pop();return null==a?(this._lock=!1,this):(this._redo.push(a),a=this._undo.length>0?this._undo[this._undo.length-1]:null,this._load(a),this.updateState(),this)},redo:function(){if(this._lock)return this;if(this.redoEvent&&!this.redoEvent())return this;this._lock=!0,this.main.menuClear();var a=this._redo.pop();return null==a?(this._lock=!1,this):(this._undo.push(a),this._load(a),this.updateState(),this)},_load:function(a){var b=this;return a?(this.canvas.getWidth()==a.w&&this.canvas.getHeight()==a.h||this.main.setCanvasSize(a.w,a.h),this.canvas.clear().renderAll(),a.json?this.canvas.loadFromJSON(a.json,function(){b.canvas.renderAll(),a.fn&&a.fn(),b._lock=!1}):a.fn&&(a.fn(),b._lock=!1)):this.historyOverflow?b._lock=!1:this._default?this._load(this._default):(this.canvas.clear().renderAll(),b.main.showPanel("paste"),b._lock=!1),this},emptyCache:function(){return this._cache=[],this},updateState:function(){return this.prev[this._undo.length>0?"removeClass":"addClass"]("disabled"),this.next[this._redo.length>0?"removeClass":"addClass"]("disabled"),this},lock:function(){return this._eventLock=!0,this},unlock:function(){return this._eventLock=!1,this}},window.jscolor||(window.jscolor=function(){var a={register:function(){a.attachDOMReadyEvent(a.init),a.attachEvent(document,"mousedown",a.onDocumentMouseDown),a.attachEvent(document,"touchstart",a.onDocumentTouchStart),a.attachEvent(window,"resize",a.onWindowResize)},init:function(){a.jscolor.lookupClass&&a.jscolor.installByClassName(a.jscolor.lookupClass)},tryInstallOnElements:function(b,c){for(var d=new RegExp("(^|\\s)("+c+")(\\s*(\\{[^}]*\\})|\\s|$)","i"),e=0;e<b.length;e+=1)if(void 0===b[e].type||"color"!=b[e].type.toLowerCase()||!a.isColorAttrSupported){var f;if(!b[e].jscolor&&b[e].className&&(f=b[e].className.match(d))){var g=b[e],h=null,i=a.getDataAttr(g,"jscolor");null!==i?h=i:f[4]&&(h=f[4]);var j={};if(h)try{j=new Function("return ("+h+")")()}catch(b){a.warn("Error parsing jscolor options: "+b+":\n"+h)}g.jscolor=new a.jscolor(g,j)}}},isColorAttrSupported:function(){var a=document.createElement("input");return!(!a.setAttribute||(a.setAttribute("type","color"),"color"!=a.type.toLowerCase()))}(),isCanvasSupported:function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))}(),fetchElement:function(a){return"string"==typeof a?document.getElementById(a):a},isElementType:function(a,b){return a.nodeName.toLowerCase()===b.toLowerCase()},getDataAttr:function(a,b){var c="data-"+b,d=a.getAttribute(c);return null!==d?d:null},attachEvent:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)},detachEvent:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent&&a.detachEvent("on"+b,c)},_attachedGroupEvents:{},attachGroupEvent:function(b,c,d,e){a._attachedGroupEvents.hasOwnProperty(b)||(a._attachedGroupEvents[b]=[]),a._attachedGroupEvents[b].push([c,d,e]),a.attachEvent(c,d,e)},detachGroupEvents:function(b){if(a._attachedGroupEvents.hasOwnProperty(b)){for(var c=0;c<a._attachedGroupEvents[b].length;c+=1){var d=a._attachedGroupEvents[b][c];a.detachEvent(d[0],d[1],d[2])}delete a._attachedGroupEvents[b]}},attachDOMReadyEvent:function(a){var b=!1,c=function(){b||(b=!0,a())};if("complete"===document.readyState)return void setTimeout(c,1);if(document.addEventListener)document.addEventListener("DOMContentLoaded",c,!1),window.addEventListener("load",c,!1);else if(document.attachEvent&&(document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",arguments.callee),c())}),window.attachEvent("onload",c),document.documentElement.doScroll&&window==window.top)){var d=function(){if(document.body)try{document.documentElement.doScroll("left"),c()}catch(a){setTimeout(d,1)}};d()}},warn:function(a){window.console&&window.console.warn&&window.console.warn(a)},preventDefault:function(a){a.preventDefault&&a.preventDefault(),a.returnValue=!1},captureTarget:function(b){b.setCapture&&(a._capturedTarget=b,a._capturedTarget.setCapture())},releaseTarget:function(){a._capturedTarget&&(a._capturedTarget.releaseCapture(),a._capturedTarget=null)},fireEvent:function(a,b){if(a)if(document.createEvent){var c=document.createEvent("HTMLEvents");c.initEvent(b,!0,!0),a.dispatchEvent(c)}else if(document.createEventObject){var c=document.createEventObject();a.fireEvent("on"+b,c)}else a["on"+b]&&a["on"+b]()},classNameToList:function(a){return a.replace(/^\s+|\s+$/g,"").split(/\s+/)},hasClass:function(a,b){return!!b&&-1!=(" "+a.className.replace(/\s+/g," ")+" ").indexOf(" "+b+" ")},setClass:function(b,c){for(var d=a.classNameToList(c),e=0;e<d.length;e+=1)a.hasClass(b,d[e])||(b.className+=(b.className?" ":"")+d[e])},unsetClass:function(b,c){for(var d=a.classNameToList(c),e=0;e<d.length;e+=1){var f=new RegExp("^\\s*"+d[e]+"\\s*|\\s*"+d[e]+"\\s*$|\\s+"+d[e]+"(\\s+)","g");b.className=b.className.replace(f,"$1")}},getStyle:function(a){return window.getComputedStyle?window.getComputedStyle(a):a.currentStyle},setStyle:function(){var a=document.createElement("div"),b=function(b){for(var c=0;c<b.length;c+=1)if(b[c]in a.style)return b[c]},c={borderRadius:b(["borderRadius","MozBorderRadius","webkitBorderRadius"]),boxShadow:b(["boxShadow","MozBoxShadow","webkitBoxShadow"])};return function(a,b,d){switch(b.toLowerCase()){case"opacity":var e=Math.round(100*parseFloat(d));a.style.opacity=d,a.style.filter="alpha(opacity="+e+")";break;default:a.style[c[b]]=d}}}(),setBorderRadius:function(b,c){a.setStyle(b,"borderRadius",c||"0")},setBoxShadow:function(b,c){a.setStyle(b,"boxShadow",c||"none")},getElementPos:function(b,c){var d=0,e=0,f=b.getBoundingClientRect();if(d=f.left,e=f.top,!c){var g=a.getViewPos();d+=g[0],e+=g[1]}return[d,e]},getElementSize:function(a){return[a.offsetWidth,a.offsetHeight]},getAbsPointerPos:function(a){a||(a=window.event);var b=0,c=0;return void 0!==a.changedTouches&&a.changedTouches.length?(b=a.changedTouches[0].clientX,c=a.changedTouches[0].clientY):"number"==typeof a.clientX&&(b=a.clientX,c=a.clientY),{x:b,y:c}},getRelPointerPos:function(a){a||(a=window.event);var b=a.target||a.srcElement,c=b.getBoundingClientRect(),d=0,e=0,f=0,g=0;return void 0!==a.changedTouches&&a.changedTouches.length?(f=a.changedTouches[0].clientX,g=a.changedTouches[0].clientY):"number"==typeof a.clientX&&(f=a.clientX,g=a.clientY),d=f-c.left,e=g-c.top,{x:d,y:e}},getViewPos:function(){var a=document.documentElement;return[(window.pageXOffset||a.scrollLeft)-(a.clientLeft||0),(window.pageYOffset||a.scrollTop)-(a.clientTop||0)]},getViewSize:function(){var a=document.documentElement;return[window.innerWidth||a.clientWidth,window.innerHeight||a.clientHeight]},redrawPosition:function(){if(a.picker&&a.picker.owner){var b,c,d=a.picker.owner;d.fixed?(b=a.getElementPos(d.targetElement,!0),c=[0,0]):(b=a.getElementPos(d.targetElement),c=a.getViewPos());var e,f,g,h=a.getElementSize(d.targetElement),i=a.getViewSize(),j=a.getPickerOuterDims(d);switch(d.position.toLowerCase()){case"left":e=1,f=0,g=-1;break;case"right":e=1,f=0,g=1;break;case"top":e=0,f=1,g=-1;break;default:e=0,f=1,g=1}var k=(h[f]+j[f])/2;if(d.smartPosition)var l=[-c[e]+b[e]+j[e]>i[e]&&-c[e]+b[e]+h[e]/2>i[e]/2&&b[e]+h[e]-j[e]>=0?b[e]+h[e]-j[e]:b[e],-c[f]+b[f]+h[f]+j[f]-k+k*g>i[f]?-c[f]+b[f]+h[f]/2>i[f]/2&&b[f]+h[f]-k-k*g>=0?b[f]+h[f]-k-k*g:b[f]+h[f]-k+k*g:b[f]+h[f]-k+k*g>=0?b[f]+h[f]-k+k*g:b[f]+h[f]-k-k*g];else var l=[b[e],b[f]+h[f]-k+k*g];var m=l[e],n=l[f],o=d.fixed?"fixed":"absolute",p=(l[0]+j[0]>b[0]||l[0]<b[0]+h[0])&&l[1]+j[1]<b[1]+h[1];a._drawPosition(d,m,n,o,p)}},_drawPosition:function(b,c,d,e,f){var g=f?0:b.shadowBlur;a.picker.wrap.style.position=e,a.picker.wrap.style.left=c+"px",a.picker.wrap.style.top=d+"px",a.setBoxShadow(a.picker.boxS,b.shadow?new a.BoxShadow(0,g,b.shadowBlur,0,b.shadowColor):null)},getPickerDims:function(b){var c=!!a.getSliderComponent(b);return[2*b.insetWidth+2*b.padding+b.width+(c?2*b.insetWidth+a.getPadToSliderPadding(b)+b.sliderSize:0),2*b.insetWidth+2*b.padding+b.height+(b.closable||b.colorInput?2*b.insetWidth+b.buttonHeight:0)]},getPickerOuterDims:function(b){var c=a.getPickerDims(b);return[c[0]+2*b.borderWidth,c[1]+2*b.borderWidth]},getPadToSliderPadding:function(a){return Math.max(a.padding,1.5*(2*a.pointerBorderWidth+a.pointerThickness))},getPadYComponent:function(a){switch(a.mode.charAt(1).toLowerCase()){case"v":return"v"}return"s"},getSliderComponent:function(a){if(a.mode.length>2)switch(a.mode.charAt(2).toLowerCase()){case"s":return"s";case"v":return"v"}return null},onDocumentMouseDown:function(b){b||(b=window.event);var c=b.target||b.srcElement;c._jscLinkedInstance?c._jscLinkedInstance.showOnClick&&c._jscLinkedInstance.show():c._jscControlName?a.onControlPointerStart(b,c,c._jscControlName,"mouse"):a.picker&&a.picker.owner&&a.picker.owner.hide()},onDocumentTouchStart:function(b){b||(b=window.event);var c=b.target||b.srcElement;c._jscLinkedInstance?c._jscLinkedInstance.showOnClick&&c._jscLinkedInstance.show():c._jscControlName?a.onControlPointerStart(b,c,c._jscControlName,"touch"):a.picker&&a.picker.owner&&a.picker.owner.hide()},onWindowResize:function(b){a.redrawPosition()},onParentScroll:function(b){a.picker&&a.picker.owner&&a.picker.owner.hide()},_pointerMoveEvent:{mouse:"mousemove",touch:"touchmove"},_pointerEndEvent:{mouse:"mouseup",touch:"touchend"},
_pointerOrigin:null,_capturedTarget:null,onControlPointerStart:function(b,c,d,e){if("colorInput"!=d){var f=c._jscInstance;a.preventDefault(b),a.captureTarget(c);var g=function(f,g){a.attachGroupEvent("drag",f,a._pointerMoveEvent[e],a.onDocumentPointerMove(b,c,d,e,g)),a.attachGroupEvent("drag",f,a._pointerEndEvent[e],a.onDocumentPointerEnd(b,c,d,e))};if(g(document,[0,0]),window.parent&&window.frameElement){var h=window.frameElement.getBoundingClientRect(),i=[-h.left,-h.top];g(window.parent.window.document,i)}var j=a.getAbsPointerPos(b),k=a.getRelPointerPos(b);switch(a._pointerOrigin={x:j.x-k.x,y:j.y-k.y},d){case"pad":switch(a.getSliderComponent(f)){case"s":0===f.hsv[1]&&f.fromHSV(null,100,null);break;case"v":0===f.hsv[2]&&f.fromHSV(null,null,100)}a.setPad(f,b,0,0);break;case"sld":a.setSld(f,b,0)}a.dispatchFineChange(f)}},onDocumentPointerMove:function(b,c,d,e,f){return function(b){var e=c._jscInstance;switch(d){case"pad":b||(b=window.event),a.setPad(e,b,f[0],f[1]),a.dispatchFineChange(e);break;case"sld":b||(b=window.event),a.setSld(e,b,f[1]),a.dispatchFineChange(e)}}},onDocumentPointerEnd:function(b,c,d,e){return function(b){var d=c._jscInstance;a.detachGroupEvents("drag"),a.releaseTarget(),a.dispatchChange(d)}},dispatchChange:function(b){b.valueElement&&a.isElementType(b.valueElement,"input")&&a.fireEvent(b.valueElement,"change")},dispatchFineChange:function(a){if(a.onFineChange){var b;b="string"==typeof a.onFineChange?new Function(a.onFineChange):a.onFineChange,b.call(a)}},setPad:function(b,c,d,e){var f=a.getAbsPointerPos(c),g=d+f.x-a._pointerOrigin.x-b.padding-b.insetWidth,h=e+f.y-a._pointerOrigin.y-b.padding-b.insetWidth,i=g*(360/(b.width-1)),j=100-h*(100/(b.height-1));switch(a.getPadYComponent(b)){case"s":b.fromHSV(i,j,null,a.leaveSld);break;case"v":b.fromHSV(i,null,j,a.leaveSld)}},setSld:function(b,c,d){var e=a.getAbsPointerPos(c),f=d+e.y-a._pointerOrigin.y-b.padding-b.insetWidth,g=100-f*(100/(b.height-1));switch(a.getSliderComponent(b)){case"s":b.fromHSV(null,g,null,a.leavePad);break;case"v":b.fromHSV(null,null,g,a.leavePad)}},_vmlNS:"jsc_vml_",_vmlCSS:"jsc_vml_css_",_vmlReady:!1,initVML:function(){if(!a._vmlReady){var b=document;if(b.namespaces[a._vmlNS]||b.namespaces.add(a._vmlNS,"urn:schemas-microsoft-com:vml"),!b.styleSheets[a._vmlCSS]){var c=["shape","shapetype","group","background","path","formulas","handles","fill","stroke","shadow","textbox","textpath","imagedata","line","polyline","curve","rect","roundrect","oval","arc","image"],d=b.createStyleSheet();d.owningElement.id=a._vmlCSS;for(var e=0;e<c.length;e+=1)d.addRule(a._vmlNS+"\\:"+c[e],"behavior:url(#default#VML);")}a._vmlReady=!0}},createPalette:function(){var b={elm:null,draw:null};if(a.isCanvasSupported){var c=document.createElement("canvas"),d=c.getContext("2d"),e=function(a,b,e){c.width=a,c.height=b,d.clearRect(0,0,c.width,c.height);var f=d.createLinearGradient(0,0,c.width,0);f.addColorStop(0,"#F00"),f.addColorStop(1/6,"#FF0"),f.addColorStop(2/6,"#0F0"),f.addColorStop(.5,"#0FF"),f.addColorStop(4/6,"#00F"),f.addColorStop(5/6,"#F0F"),f.addColorStop(1,"#F00"),d.fillStyle=f,d.fillRect(0,0,c.width,c.height);var g=d.createLinearGradient(0,0,0,c.height);switch(e.toLowerCase()){case"s":g.addColorStop(0,"rgba(255,255,255,0)"),g.addColorStop(1,"rgba(255,255,255,1)");break;case"v":g.addColorStop(0,"rgba(0,0,0,0)"),g.addColorStop(1,"rgba(0,0,0,1)")}d.fillStyle=g,d.fillRect(0,0,c.width,c.height)};b.elm=c,b.draw=e}else{a.initVML();var f=document.createElement("div");f.style.position="relative",f.style.overflow="hidden";var g=document.createElement(a._vmlNS+":fill");g.type="gradient",g.method="linear",g.angle="90",g.colors="16.67% #F0F, 33.33% #00F, 50% #0FF, 66.67% #0F0, 83.33% #FF0";var h=document.createElement(a._vmlNS+":rect");h.style.position="absolute",h.style.left="-1px",h.style.top="-1px",h.stroked=!1,h.appendChild(g),f.appendChild(h);var i=document.createElement(a._vmlNS+":fill");i.type="gradient",i.method="linear",i.angle="180",i.opacity="0";var j=document.createElement(a._vmlNS+":rect");j.style.position="absolute",j.style.left="-1px",j.style.top="-1px",j.stroked=!1,j.appendChild(i),f.appendChild(j);var e=function(a,b,c){switch(f.style.width=a+"px",f.style.height=b+"px",h.style.width=j.style.width=a+1+"px",h.style.height=j.style.height=b+1+"px",g.color="#F00",g.color2="#F00",c.toLowerCase()){case"s":i.color=i.color2="#FFF";break;case"v":i.color=i.color2="#000"}};b.elm=f,b.draw=e}return b},createSliderGradient:function(){var b={elm:null,draw:null};if(a.isCanvasSupported){var c=document.createElement("canvas"),d=c.getContext("2d"),e=function(a,b,e,f){c.width=a,c.height=b,d.clearRect(0,0,c.width,c.height);var g=d.createLinearGradient(0,0,0,c.height);g.addColorStop(0,e),g.addColorStop(1,f),d.fillStyle=g,d.fillRect(0,0,c.width,c.height)};b.elm=c,b.draw=e}else{a.initVML();var f=document.createElement("div");f.style.position="relative",f.style.overflow="hidden";var g=document.createElement(a._vmlNS+":fill");g.type="gradient",g.method="linear",g.angle="180";var h=document.createElement(a._vmlNS+":rect");h.style.position="absolute",h.style.left="-1px",h.style.top="-1px",h.stroked=!1,h.appendChild(g),f.appendChild(h);var e=function(a,b,c,d){f.style.width=a+"px",f.style.height=b+"px",h.style.width=a+1+"px",h.style.height=b+1+"px",g.color=c,g.color2=d};b.elm=f,b.draw=e}return b},leaveValue:1,leaveStyle:2,leavePad:4,leaveSld:8,BoxShadow:function(){var a=function(a,b,c,d,e,f){this.hShadow=a,this.vShadow=b,this.blur=c,this.spread=d,this.color=e,this.inset=!!f};return a.prototype.toString=function(){var a=[Math.round(this.hShadow)+"px",Math.round(this.vShadow)+"px",Math.round(this.blur)+"px",Math.round(this.spread)+"px",this.color];return this.inset&&a.push("inset"),a.join(" ")},a}(),jscolor:function(b,c){function d(a,b,c){a/=255,b/=255,c/=255;var d=Math.min(Math.min(a,b),c),e=Math.max(Math.max(a,b),c),f=e-d;if(0===f)return[null,0,100*e];var g=a===d?3+(c-b)/f:b===d?5+(a-c)/f:1+(b-a)/f;return[60*(6===g?0:g),f/e*100,100*e]}function e(a,b,c){var d=c/100*255;if(null===a)return[d,d,d];a/=60,b/=100;var e=Math.floor(a),f=e%2?a-e:1-(a-e),g=d*(1-b),h=d*(1-b*f);switch(e){case 6:case 0:return[d,h,g];case 1:return[h,d,g];case 2:return[g,d,h];case 3:return[g,h,d];case 4:return[h,g,d];case 5:return[d,g,h]}}function f(){a.unsetClass(o.targetElement,o.activeClass),a.picker.wrap.parentNode.removeChild(a.picker.wrap),delete a.picker.owner}function g(){o._processParentElementsInDOM(),a.picker||(a.picker={owner:null,wrap:document.createElement("div"),box:document.createElement("div"),boxS:document.createElement("div"),boxB:document.createElement("div"),pad:document.createElement("div"),padB:document.createElement("div"),padM:document.createElement("div"),padPal:a.createPalette(),cross:document.createElement("div"),crossBY:document.createElement("div"),crossBX:document.createElement("div"),crossLY:document.createElement("div"),crossLX:document.createElement("div"),sld:document.createElement("div"),sldB:document.createElement("div"),sldM:document.createElement("div"),sldGrad:a.createSliderGradient(),sldPtrS:document.createElement("div"),sldPtrIB:document.createElement("div"),sldPtrMB:document.createElement("div"),sldPtrOB:document.createElement("div"),colorInput:document.createElement("input"),btnNone:document.createElement("div"),btnNoneT:document.createElement("span"),btn:document.createElement("div"),btnT:document.createElement("span")},a.picker.pad.appendChild(a.picker.padPal.elm),a.picker.padB.appendChild(a.picker.pad),a.picker.cross.appendChild(a.picker.crossBY),a.picker.cross.appendChild(a.picker.crossBX),a.picker.cross.appendChild(a.picker.crossLY),a.picker.cross.appendChild(a.picker.crossLX),a.picker.padB.appendChild(a.picker.cross),a.picker.box.appendChild(a.picker.padB),a.picker.box.appendChild(a.picker.padM),a.picker.sld.appendChild(a.picker.sldGrad.elm),a.picker.sldB.appendChild(a.picker.sld),a.picker.sldB.appendChild(a.picker.sldPtrOB),a.picker.sldPtrOB.appendChild(a.picker.sldPtrMB),a.picker.sldPtrMB.appendChild(a.picker.sldPtrIB),a.picker.sldPtrIB.appendChild(a.picker.sldPtrS),a.picker.box.appendChild(a.picker.sldB),a.picker.box.appendChild(a.picker.sldM),a.picker.box.appendChild(a.picker.colorInput),a.picker.btnNone.appendChild(a.picker.btnNoneT),a.picker.box.appendChild(a.picker.btnNone),a.picker.btn.appendChild(a.picker.btnT),a.picker.box.appendChild(a.picker.btn),a.picker.boxB.appendChild(a.picker.box),a.picker.wrap.appendChild(a.picker.boxS),a.picker.wrap.appendChild(a.picker.boxB));var b=a.picker,c=!!a.getSliderComponent(o),d=a.getPickerDims(o),e=2*o.pointerBorderWidth+o.pointerThickness+2*o.crossSize,f=a.getPadToSliderPadding(o),g=Math.min(o.borderRadius,Math.round(o.padding*Math.PI));b.wrap.style.clear="both",b.wrap.style.width=d[0]+2*o.borderWidth+"px",b.wrap.style.height=d[1]+2*o.borderWidth+"px",b.wrap.style.zIndex=o.zIndex,b.box.style.width=d[0]+"px",b.box.style.height=d[1]+"px",b.boxS.style.position="absolute",b.boxS.style.left="0",b.boxS.style.top="0",b.boxS.style.width="100%",b.boxS.style.height="100%",a.setBorderRadius(b.boxS,g+"px"),b.boxB.style.position="relative",b.boxB.style.border=o.borderWidth+"px solid",b.boxB.style.borderColor=o.borderColor,b.boxB.style.background=o.backgroundColor,a.setBorderRadius(b.boxB,g+"px"),b.padM.style.background=b.sldM.style.background="#FFF",a.setStyle(b.padM,"opacity","0"),a.setStyle(b.sldM,"opacity","0"),b.pad.style.position="relative",b.pad.style.width=o.width+"px",b.pad.style.height=o.height+"px",b.padPal.draw(o.width,o.height,a.getPadYComponent(o)),b.padB.style.position="absolute",b.padB.style.left=o.padding+"px",b.padB.style.top=o.padding+"px",b.padB.style.border=o.insetWidth+"px solid",b.padB.style.borderColor=o.insetColor,b.padM._jscInstance=o,b.padM._jscControlName="pad",b.padM.style.position="absolute",b.padM.style.left="0",b.padM.style.top="0",b.padM.style.width=o.padding+2*o.insetWidth+o.width+f/2+"px",b.padM.style.height=d[1]+"px",b.padM.style.cursor="crosshair",b.cross.style.position="absolute",b.cross.style.left=b.cross.style.top="0",b.cross.style.width=b.cross.style.height=e+"px",b.crossBY.style.position=b.crossBX.style.position="absolute",b.crossBY.style.background=b.crossBX.style.background=o.pointerBorderColor,b.crossBY.style.width=b.crossBX.style.height=2*o.pointerBorderWidth+o.pointerThickness+"px",b.crossBY.style.height=b.crossBX.style.width=e+"px",b.crossBY.style.left=b.crossBX.style.top=Math.floor(e/2)-Math.floor(o.pointerThickness/2)-o.pointerBorderWidth+"px",b.crossBY.style.top=b.crossBX.style.left="0",b.crossLY.style.position=b.crossLX.style.position="absolute",b.crossLY.style.background=b.crossLX.style.background=o.pointerColor,b.crossLY.style.height=b.crossLX.style.width=e-2*o.pointerBorderWidth+"px",b.crossLY.style.width=b.crossLX.style.height=o.pointerThickness+"px",b.crossLY.style.left=b.crossLX.style.top=Math.floor(e/2)-Math.floor(o.pointerThickness/2)+"px",b.crossLY.style.top=b.crossLX.style.left=o.pointerBorderWidth+"px",b.sld.style.overflow="hidden",b.sld.style.width=o.sliderSize+"px",b.sld.style.height=o.height+"px",b.sldGrad.draw(o.sliderSize,o.height,"#000","#000"),b.sldB.style.display=c?"block":"none",b.sldB.style.position="absolute",b.sldB.style.right=o.padding+"px",b.sldB.style.top=o.padding+"px",b.sldB.style.border=o.insetWidth+"px solid",b.sldB.style.borderColor=o.insetColor,b.sldM._jscInstance=o,b.sldM._jscControlName="sld",b.sldM.style.display=c?"block":"none",b.sldM.style.position="absolute",b.sldM.style.right="0",b.sldM.style.top="0",b.sldM.style.width=o.sliderSize+f/2+o.padding+2*o.insetWidth+"px",b.sldM.style.height=d[1]+"px",b.sldM.style.cursor="default",b.sldPtrIB.style.border=b.sldPtrOB.style.border=o.pointerBorderWidth+"px solid "+o.pointerBorderColor,b.sldPtrOB.style.position="absolute",b.sldPtrOB.style.left=-(2*o.pointerBorderWidth+o.pointerThickness)+"px",b.sldPtrOB.style.top="0",b.sldPtrMB.style.border=o.pointerThickness+"px solid "+o.pointerColor,b.sldPtrS.style.width=o.sliderSize+"px",b.sldPtrS.style.height=q+"px",b.colorInput._jscControlName="colorInput",b.colorInput.style.display=o.colorInput?"block":"none",b.colorInput.style.position="absolute",b.colorInput.style.left=o.padding+"px",b.colorInput.style.bottom=o.padding+"px",b.colorInput.style.padding="0px",b.colorInput.style.height=o.buttonHeight+"px",b.colorInput.style.border=o.insetWidth+"px solid",b.colorInput.style.color=o.buttonColor,b.colorInput.style.font="12px sans-serif",b.colorInput.style.textAlign="left",b.colorInput.style.width="55px",b.colorInput.onkeyup=function(a){var b=this.value;-1==b.search(/^#[0-9A-F]{0,6}$/i)&&(this.value=""),7!=b.length&&""!=b||o.fromString(b)};var j=o.toString();o.uppercase&&(j=j.toUpperCase()),j=o.__select_color&&j?"#"+j:"",b.colorInput.value=j,b.btnNone._jscControlName="colorInput",b.btnNone.style.display=o.colorInput?"block":"none",b.btnNone.style.position="absolute",b.btnNone.style.left=o.padding+60+"px",b.btnNone.style.bottom=o.padding+"px",b.btnNone.style.padding="0 5px",b.btnNone.style.height=o.buttonHeight+"px",b.btnNone.style.border=o.insetWidth+"px solid",b.btnNone.style.color=o.buttonColor,b.btnNone.style.font="12px sans-serif",b.btnNone.style.textAlign="center";try{b.btnNone.style.cursor="pointer"}catch(a){b.btnNone.style.cursor="hand"}b.btnNoneT._jscControlName="colorInput",b.btnNoneT.style.lineHeight=o.buttonHeight+"px",b.btnNoneT.innerHTML="None",b.btnNone.onmousedown=function(){o.fromString("")},b.btn.style.display=o.closable?"block":"none",b.btn.style.position="absolute",b.btn.style.right=o.padding+"px",b.btn.style.bottom=o.padding+"px",b.btn.style.padding="0 5px",b.btn.style.height=o.buttonHeight+"px",b.btn.style.border=o.insetWidth+"px solid",function(){var a=o.insetColor.split(/\s+/),c=a.length<2?a[0]:a[1]+" "+a[0]+" "+a[0]+" "+a[1];b.btn.style.borderColor=c,b.btnNone.style.borderColor=c,b.colorInput.style.borderColor=c}(),b.btn.style.color=o.buttonColor,b.btn.style.font="12px sans-serif",b.btn.style.textAlign="center";try{b.btn.style.cursor="pointer"}catch(a){b.btn.style.cursor="hand"}b.btn.onmousedown=function(){o.hide()},b.btnT.style.lineHeight=o.buttonHeight+"px",b.btnT.innerHTML="",b.btnT.appendChild(document.createTextNode(o.closeText)),h(),i(),a.picker.owner&&a.picker.owner!==o&&a.unsetClass(a.picker.owner.targetElement,o.activeClass),a.picker.owner=o,a.isElementType(p,"body")?a.redrawPosition():a._drawPosition(o,0,0,"relative",!1),b.wrap.parentNode!=p&&p.appendChild(b.wrap),a.setClass(o.targetElement,o.activeClass)}function h(){switch(a.getPadYComponent(o)){case"s":var b=1;break;case"v":var b=2}var c=Math.round(o.hsv[0]/360*(o.width-1)),d=Math.round((1-o.hsv[b]/100)*(o.height-1)),f=2*o.pointerBorderWidth+o.pointerThickness+2*o.crossSize,g=-Math.floor(f/2);switch(a.picker.cross.style.left=c+g+"px",a.picker.cross.style.top=d+g+"px",a.getSliderComponent(o)){case"s":var h=e(o.hsv[0],100,o.hsv[2]),i=e(o.hsv[0],0,o.hsv[2]),j="rgb("+Math.round(h[0])+","+Math.round(h[1])+","+Math.round(h[2])+")",k="rgb("+Math.round(i[0])+","+Math.round(i[1])+","+Math.round(i[2])+")";a.picker.sldGrad.draw(o.sliderSize,o.height,j,k);break;case"v":var l=e(o.hsv[0],o.hsv[1],100),j="rgb("+Math.round(l[0])+","+Math.round(l[1])+","+Math.round(l[2])+")",k="#000";a.picker.sldGrad.draw(o.sliderSize,o.height,j,k)}}function i(){var b=a.getSliderComponent(o);if(b){switch(b){case"s":var c=1;break;case"v":var c=2}var d=Math.round((1-o.hsv[c]/100)*(o.height-1));a.picker.sldPtrOB.style.top=d-(2*o.pointerBorderWidth+o.pointerThickness)-Math.floor(q/2)+"px"}}function j(){return a.picker&&a.picker.owner===o}function k(){o.importColor()}this.value=null,this.valueElement=b,this.styleElement=b,this.required=!0,this.refine=!0,this.hash=!1,this.uppercase=!0,this.onFineChange=null,this.activeClass="jscolor-active",this.minS=0,this.maxS=100,this.minV=0,this.maxV=100,this.hsv=[0,0,100],this.rgb=[255,255,255],this.width=181,this.height=101,this.showOnClick=!0,this.mode="HSV",this.position="bottom",this.smartPosition=!0,this.sliderSize=16,this.crossSize=8,this.closable=!1,this.closeText="Close",this.buttonColor="#000000",this.buttonHeight=21,this.padding=12,this.backgroundColor="#FFFFFF",this.borderWidth=1,this.borderColor="#BBBBBB",this.borderRadius=8,this.insetWidth=1,this.insetColor="#BBBBBB",this.shadow=!0,this.shadowBlur=15,this.shadowColor="rgba(0,0,0,0.2)",this.pointerColor="#4C4C4C",this.pointerBorderColor="#FFFFFF",this.pointerBorderWidth=1,this.pointerThickness=2,this.zIndex=1e3,this.container=null,this.colorInput=!1;for(var l in c)c.hasOwnProperty(l)&&(this[l]=c[l]);if(this.hide=function(){j()&&f()},this.show=function(){g()},this.redraw=function(){j()&&g()},this.importColor=function(){this.valueElement&&a.isElementType(this.valueElement,"input")?this.refine?!this.required&&/^\s*$/.test(this.valueElement.value)?(this.valueElement.value="",this.styleElement&&(this.styleElement.style.backgroundImage=this.styleElement._jscOrigStyle.backgroundImage,this.styleElement.style.backgroundColor=this.styleElement._jscOrigStyle.backgroundColor,this.styleElement.style.color=this.styleElement._jscOrigStyle.color),this.exportColor(a.leaveValue|a.leaveStyle)):this.fromString(this.valueElement.value)||this.exportColor():this.fromString(this.valueElement.value,a.leaveValue)||(this.styleElement&&(this.styleElement.style.backgroundImage=this.styleElement._jscOrigStyle.backgroundImage,this.styleElement.style.backgroundColor=this.styleElement._jscOrigStyle.backgroundColor,this.styleElement.style.color=this.styleElement._jscOrigStyle.color),this.exportColor(a.leaveValue|a.leaveStyle)):this.exportColor()},this.exportColor=function(b){if(!(b&a.leaveValue)&&this.valueElement){var c=this.toString();this.uppercase&&(c=c.toUpperCase()),this.hash&&(c="#"+c),c=this.__select_color?c:"",a.isElementType(this.valueElement,"input")?this.valueElement.value=c:this.valueElement.innerHTML=c,a.picker&&a.picker.colorInput&&(a.picker.colorInput.value=(c&&!this.hash?"#":"")+c)}b&a.leaveStyle||(this.styleElement&&this.__select_color&&(this.styleElement.style.backgroundImage="none",this.styleElement.style.backgroundColor="#"+this.toString(),this.styleElement.style.color=this.isLight()?"#000":"#FFF"),this.styleElement&&$(this.styleElement)[this.__select_color?"removeClass":"addClass"]("none"),this.valueElement&&$(this.valueElement)[this.__select_color?"removeClass":"addClass"]("none_color")),this.eventChangeValue&&this.eventChangeValue("#"+this.toString(),this.__select_color),b&a.leavePad||!j()||h(),b&a.leaveSld||!j()||i()},this.fromHSV=function(a,b,c,d){if(null!==a){if(isNaN(a))return!1;a=Math.max(0,Math.min(360,a))}if(null!==b){if(isNaN(b))return!1;b=Math.max(0,Math.min(100,this.maxS,b),this.minS)}if(null!==c){if(isNaN(c))return!1;c=Math.max(0,Math.min(100,this.maxV,c),this.minV)}this.rgb=e(null===a?this.hsv[0]:this.hsv[0]=a,null===b?this.hsv[1]:this.hsv[1]=b,null===c?this.hsv[2]:this.hsv[2]=c),this.__select_color=!0,this.exportColor(d)},this.fromRGB=function(a,b,c,f){if(null!==a){if(isNaN(a))return!1;a=Math.max(0,Math.min(255,a))}if(null!==b){if(isNaN(b))return!1;b=Math.max(0,Math.min(255,b))}if(null!==c){if(isNaN(c))return!1;c=Math.max(0,Math.min(255,c))}var g=d(null===a?this.rgb[0]:a,null===b?this.rgb[1]:b,null===c?this.rgb[2]:c);null!==g[0]&&(this.hsv[0]=Math.max(0,Math.min(360,g[0]))),0!==g[2]&&(this.hsv[1]=null===g[1]?null:Math.max(0,this.minS,Math.min(100,this.maxS,g[1]))),this.hsv[2]=null===g[2]?null:Math.max(0,this.minV,Math.min(100,this.maxV,g[2]));var h=e(this.hsv[0],this.hsv[1],this.hsv[2]);this.rgb[0]=h[0],this.rgb[1]=h[1],this.rgb[2]=h[2],this.__select_color=!0,this.exportColor(f)},this.fromString=function(a,b){var c;if(""==a)return a=this.noneColor||"#000000",c=a.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i),this.fromRGB(parseInt(c[1].substr(0,2),16),parseInt(c[1].substr(2,2),16),parseInt(c[1].substr(4,2),16),b),this.__select_color=!1,this.exportColor(b),!0;if(c=a.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i))return 6===c[1].length?this.fromRGB(parseInt(c[1].substr(0,2),16),parseInt(c[1].substr(2,2),16),parseInt(c[1].substr(4,2),16),b):this.fromRGB(parseInt(c[1].charAt(0)+c[1].charAt(0),16),parseInt(c[1].charAt(1)+c[1].charAt(1),16),parseInt(c[1].charAt(2)+c[1].charAt(2),16),b),!0;if(c=a.match(/^\W*rgba?\(([^)]*)\)\W*$/i)){var d,e,f,g=c[1].split(","),h=/^\s*(\d*)(\.\d+)?\s*$/;if(g.length>=3&&(d=g[0].match(h))&&(e=g[1].match(h))&&(f=g[2].match(h))){var i=parseFloat((d[1]||"0")+(d[2]||"")),j=parseFloat((e[1]||"0")+(e[2]||"")),k=parseFloat((f[1]||"0")+(f[2]||""));return this.fromRGB(i,j,k,b),!0}}return!1},this.toString=function(){return(256|Math.round(this.rgb[0])).toString(16).substr(1)+(256|Math.round(this.rgb[1])).toString(16).substr(1)+(256|Math.round(this.rgb[2])).toString(16).substr(1)},this.toHEXString=function(){return"#"+this.toString().toUpperCase()},this.toRGBString=function(){return"rgb("+Math.round(this.rgb[0])+","+Math.round(this.rgb[1])+","+Math.round(this.rgb[2])+")"},this.isLight=function(){return.213*this.rgb[0]+.715*this.rgb[1]+.072*this.rgb[2]>127.5},this._processParentElementsInDOM=function(){if(!this._linkedElementsProcessed){this._linkedElementsProcessed=!0;var b=this.targetElement;do{var c=a.getStyle(b);c&&"fixed"===c.position.toLowerCase()&&(this.fixed=!0),b!==this.targetElement&&(b._jscEventsAttached||(a.attachEvent(b,"scroll",a.onParentScroll),b._jscEventsAttached=!0))}while((b=b.parentNode)&&!a.isElementType(b,"body"))}},"string"==typeof b){var m=b,n=document.getElementById(m);n?this.targetElement=n:a.warn("Could not find target element with ID '"+m+"'")}else b?this.targetElement=b:a.warn("Invalid target element: '"+b+"'");if(this.targetElement._jscLinkedInstance)return void a.warn("Cannot link jscolor twice to the same element. Skipping.");this.targetElement._jscLinkedInstance=this,this.valueElement=a.fetchElement(this.valueElement),this.styleElement=a.fetchElement(this.styleElement),this.__select_color=!1;var o=this,p=this.container?a.fetchElement(this.container):document.getElementsByTagName("body")[0],q=3;if(a.isElementType(this.targetElement,"button"))if(this.targetElement.onclick){var r=this.targetElement.onclick;this.targetElement.onclick=function(a){return r.call(this,a),!1}}else this.targetElement.onclick=function(){return!1};if(this.valueElement&&a.isElementType(this.valueElement,"input")){var s=function(){o.fromString(o.valueElement.value,a.leaveValue),a.dispatchFineChange(o)};a.attachEvent(this.valueElement,"keyup",s),a.attachEvent(this.valueElement,"input",s),a.attachEvent(this.valueElement,"blur",k),this.valueElement.setAttribute("autocomplete","off")}this.styleElement&&(this.styleElement._jscOrigStyle={backgroundImage:this.styleElement.style.backgroundImage,backgroundColor:this.styleElement.style.backgroundColor,color:this.styleElement.style.color}),this.value?this.fromString(this.value)||this.exportColor():this.importColor()}};return a.jscolor.lookupClass="jscolor",a.jscolor.installByClassName=function(b){var c=document.getElementsByTagName("input"),d=document.getElementsByTagName("button");a.tryInstallOnElements(c,b),a.tryInstallOnElements(d,b)},a.register(),a.jscolor}()),TextTools.prototype={initialize:function(a){var b=this,c=a||{};this.main=c.main,this.styleEl=c.styleEl||{},this.bold=!1,this.italic=!1,this.underline=!1,this.active_text_box=null,this.styleEl.bold.on("click",function(a){b.toggle("bold")}),this.styleEl.italic.on("click",function(a){b.toggle("italic")}),this.styleEl.underline.on("click",function(a){b.toggle("underline")}),this.styleEl.color.on("click",function(a){this.jscolor&&this.jscolor.show()}),this.styleEl.bg_color.on("click",function(a){this.jscolor&&this.jscolor.show()})},createHandler:function(){this.activeTools=!0,this.main.canvas.selection=!1,this.main.img&&this.main.img.hoverCursor&&(this.main.img.hoverCursor="text");var a=this;this.main.canvas.on("mouse:down",function(b){setTimeout(function(){a.createTextbox(b)},0)})},removeHandler:function(){this.activeTools&&(this.activeTools=!1,this.main.img&&this.main.img.hoverCursor&&(this.main.img.hoverCursor="default"),this.active_text_box&&this.active_text_box.exitEditing(),this.main.canvas.off("mouse:down"),this.main.canvas.selection=!0)},getPosition:function(a){var b=this.main.canvas.getPointer(a.e);return{x:b.x,y:b.y}},createTextbox:function(a){var b=this;if(a&&a.target&&"image"!=a.target.type)return!0;var c=this.getPosition(a),d={left:c.x,top:c.y-10,padding:5,fontFamily:this.styleEl.font.val(),fontSize:fabric.util.parseUnit(this.styleEl.size.val()+"pt")};this.bold&&(d.fontWeight="bold"),this.italic&&(d.fontStyle="italic"),this.underline&&(d.underline=this.underline),this.styleEl.color&&this.styleEl.color[0]&&this.styleEl.color[0].innerHTML&&(d.fill="#"+this.styleEl.color[0].innerHTML),this.styleEl.bg_color&&this.styleEl.bg_color[0]&&this.styleEl.bg_color[0].innerHTML&&(d.textBackgroundColor="#"+this.styleEl.bg_color[0].innerHTML);var e=new fabric.IText("",d);e.on("editing:entered",function(){b.active_text_box=this}),e.on("editing:exited",function(){""==this.text.replace(/\s*/g,"")?b.main.canvas.remove(this):function(a,b,c){setTimeout(function(){b.active_text_box!=c&&(b.main.history.lock(),a.remove(c),a.add(c),a.requestRenderAll(),b.main.history.unlock())},500)}(b.main.canvas,b,this),b.main.canvas.requestRenderAll(),b.active_text_box=null}),b.main.canvas.add(e).setActiveObject(e),e.enterEditing(),b.active_text_box=e},_styleChange:function(a){this[a]=!this[a],this.styleEl[a]&&$(this.styleEl[a])[this[a]?"addClass":"removeClass"]("on")},toggle:function(a){this._styleChange(a)}},ResizeTools.prototype={initialize:function(a){var b=a||{};this.main=b.main,this.styleEl=b.styleEl||{},this.group=null},createHandler:function(){this.activeTools=!0,this.main.history.save(),this.main.history.lock();var a=this;this.main.status.canvas_fullsize_mode=!0;var b=this.group=new fabric.Group;this.group.setControlsVisibility({bl:!0,br:!0,mb:!0,ml:!0,mr:!0,mt:!0,tl:!0,tr:!0,mtr:!1}),this.main.canvas.getObjects().map(function(a){b.addWithUpdate(a)}),this.main.setCanvasSize(),this.main.canvas.add(b),this.main.canvas.discardActiveObject(),this.group.left=10,this.group.top=10,this.group.setCoords(),this.main.canvas.setActiveObject(this.group).renderAll(),this.ratio=!0,this.updateSize(),this._originSize=this.group.getBoundingRect(),this.styleEl.width&&this.styleEl.width.unbind("keyup").on("keyup",function(){var b=parseInt(this.value,10);isNaN(b)?this.value="":a.setSize(b,null)}),this.styleEl.height&&this.styleEl.height.unbind("keyup").on("keyup",function(){var b=parseInt(this.value,10);isNaN(b)?this.value="":a.setSize(null,b)}),this.styleEl.ratio&&this.styleEl.ratio.unbind("click").on("click",function(){$(this).hasClass("toggle_on")?($(this).removeClass("toggle_on"),a.ratio=!1):($(this).addClass("toggle_on"),a.ratio=!0)}),this.styleEl.ratio&&(this.ratio=$(this.styleEl.ratio).hasClass("toggle_on")),this.styleEl.origin&&this.styleEl.origin.unbind("click").on("click",function(){var b=a.main.status.angle;0==b||180==b?a.setSize(a.main.originImgInfo.width,a.main.originImgInfo.height,!1):a.setSize(a.main.originImgInfo.height,a.main.originImgInfo.width,!1)}),this._req=null,this.main.canvas.on("object:scaling",function(b){b.target===a.group&&(a._req&&clearTimeout(a._req),a._req=setTimeout(function(){a.updateSize()},800))})},removeHandler:function(){if(this.activeTools){if(this.activeTools=!1,this.main.status.canvas_fullsize_mode=!1,this.styleEl.width&&this.styleEl.width.unbind("keyup"),this.styleEl.height&&this.styleEl.height.unbind("keyup"),this.styleEl.ratio&&this.styleEl.ratio.unbind("click"),this.styleEl.origin&&this.styleEl.origin.unbind("click"),this.group){this.main.canvas.off("object:scaling");var a=this.group.getObjects();this.group.remove(a);var b=this.group.getBoundingRect();this.main.setCanvasSize(b.width,b.height),this.main.canvas.centerObject(this.group),this.group.setCoords(),this.main.canvas.remove(this.group),this.group.destroy(),this.group=null,this.main.canvas.renderAll(),this.main.history.unlock(),b.width==this._originSize.width&&b.height==this._originSize.height||this.main.history.add(!0,function(a,b,c){return function(){}}(this.main,b.width,b.height)).save()}}},updateSize:function(){var a=this.group.getBoundingRect();this.styleEl.width&&this.styleEl.width.val(Math.round(a.width)),this.styleEl.height&&this.styleEl.height.val(Math.round(a.height))},setSize:function(a,b,c){var d=this;this._req&&clearTimeout(this._req);var e=this.group.scaleX,f=this.group.scaleY;null!=a&&(e=a/this.group.width),null!=b&&(f=b/this.group.height),c&&(e=f=1),null!=a&&this.ratio&&(f=e),null!=b&&this.ratio&&(e=f),this.group.animate({scaleX:e,scaleY:f,left:10,top:10},{duration:200,onChange:this.main.canvas.renderAll.bind(this.main.canvas),onComplete:function(){d.group.setCoords(),d._req=setTimeout(function(){d.updateSize()},100)}})}},ShapeTools.prototype={initialize:function(a){var b=a||{},c=this;this.main=b.main,this.styleEl=b.styleEl||{},this.styleEl.rect.on("click",function(){$(this).hasClass("on")||c.changeType("rect",$(this).attr("title"))}),this.styleEl.round_rect.on("click",function(){$(this).hasClass("on")||c.changeType("round_rect",$(this).attr("title"))}),this.styleEl.circle.on("click",function(){$(this).hasClass("on")||c.changeType("circle",$(this).attr("title"))}),this.styleEl.line.on("click",function(){$(this).hasClass("on")||c.changeType("line",$(this).attr("title"))}),this.styleEl.bg_color.on("click",function(a){this.jscolor&&this.jscolor.show()}),this.styleEl.line_color.on("click",function(a){this.jscolor&&this.jscolor.show()}),this.styleEl.bg_color_span.on("click",function(a){c.styleEl.bg_color[0].jscolor&&c.styleEl.bg_color[0].jscolor.show()}),this.styleEl.line_color_span.on("click",function(a){c.styleEl.line_color[0].jscolor&&c.styleEl.line_color[0].jscolor.show()}),this.isDown=!1,this.type="rect",this.lineWidth=null,this.lineStyle=null,this.lineColor=null,this.bgColor=null,this.origX=null,this.origY=null,this.activeObject=null,this.colorEl=this.styleEl.bg_color_span[0],this.lineColorEl=this.styleEl.line_color_span[0]},createHandler:function(){this.activeTools=!0,this.main.canvas.selection=!1,this.main.img&&this.main.img.hoverCursor&&(this.main.img.hoverCursor="crosshair"),this.main.canvas.on("mouse:down",this.createShape.bind(this)),this.main.canvas.on("mouse:move",this.createShapeMouseMove.bind(this)),this.main.canvas.on("mouse:up",this.createShapeMouseUp.bind(this))},removeHandler:function(){this.activeTools&&(this.activeTools=!1,this.main.img&&this.main.img.hoverCursor&&(this.main.img.hoverCursor="default"),this.main.canvas.off("mouse:down"),this.main.canvas.off("mouse:move"),this.main.canvas.off("mouse:up"),this.main.canvas.discardActiveObject().requestRenderAll(),this.main.canvas.selection=!0)},changeType:function(a,b){$(this.styleEl.main).removeClass("btn_"+this.type),this.styleEl[this.type].removeClass("on"),this.type=a,this.styleEl[this.type].addClass("on"),$(this.styleEl.main).addClass("btn_"+this.type),$(this.styleEl.main).attr("title",b)},getPosition:function(a){var b=this.main.canvas.getPointer(a.e);return{x:b.x,y:b.y}},createShape:function(a){if(a&&a.target&&"image"!=a.target.type)return!0;this.main.history.save().lock(),this.isDown=!0;var b=this.getPosition(a);switch(this.origX=b.x,this.origY=b.y,this.type){case"rect":this.activeObject=this.rect();break;case"round_rect":this.activeObject=this.rect(),this.activeObject.set({rx:20,ry:20});break;case"circle":this.activeObject=this.circle();break;case"line":this.activeObject=this.line()}this.main.canvas.add(this.activeObject)},createShapeMouseMove:function(a){if(this.isDown){var b=this.getPosition(a);if("rect"==this.type||"round_rect"==this.type){var c={};this.origX>b.x&&(c.left=Math.abs(b.x)),this.origY>b.y&&(c.top=Math.abs(b.y)),c.width=Math.abs(this.origX-b.x),c.height=Math.abs(this.origY-b.y),c.width+=c.width%2+(this._isodd?-1:0),c.height+=c.height%2+(this._isodd?-1:0),a&&a.e&&a.e.shiftKey&&(c.width>c.height?c.height=c.width:c.width=c.height),this.activeObject.set(c)}else if("circle"==this.type){
var d=Math.abs(this.origX-b.x)/2,e=Math.abs(this.origY-b.y)/2;d>this.activeObject.strokeWidth&&(d-=this.activeObject.strokeWidth/2),e>this.activeObject.strokeWidth&&(e-=this.activeObject.strokeWidth/2),d+=d%2+(this._isodd?-1:0),e+=e%2+(this._isodd?-1:0),a&&a.e&&a.e.shiftKey&&(d>e?e=d:d=e),this.activeObject.set({rx:d,ry:e}),this.origX>b.x?this.activeObject.set({originX:"right"}):this.activeObject.set({originX:"left"}),this.origY>b.y?this.activeObject.set({originY:"bottom"}):this.activeObject.set({originY:"top"})}else if("line"==this.type){var f=b.x,g=b.y;a&&a.e&&a.e.shiftKey&&(Math.abs(this.origX-f)>Math.abs(this.origY-g)?g=this.origY:f=this.origX),this.activeObject.set({x2:f,y2:g})}this.main.canvas.renderAll()}},createShapeMouseUp:function(){this.isDown&&(this.isDown=!1,this.main.canvas.remove(this.activeObject),this.main.canvas.add(this.activeObject),this.activeObject=null,this.main.canvas.requestRenderAll(),this.main.history.unlock().add().save())},rect:function(){var a=this.styleEl.style.val(),b=this.__lineWidth=parseInt(this.styleEl.size.val(),10);this._isodd=this.__lineWidth%2==1;var c=$(this.colorEl).hasClass("none")?"rgba(0,0,0,0)":this.colorEl.style.backgroundColor;return new fabric.Rect({left:this.origX,top:this.origY,originX:"left",originY:"top",width:0,height:0,angle:0,strokeDashArray:"dash"==a?[10,5]:"dot"==a?[5,5]:[0,0],fill:c,strokeWidth:b,stroke:0==b||$(this.lineColorEl).hasClass("none")?this.colorEl.style.backgroundColor:this.lineColorEl.style.backgroundColor})},circle:function(){var a=this.styleEl.style.val(),b=parseInt(this.styleEl.size.val(),10),c=$(this.colorEl).hasClass("none")?"rgba(0,0,0,0)":this.colorEl.style.backgroundColor;return new fabric.Ellipse({left:this.origX,top:this.origY,originX:"left",originY:"top",rx:0,ry:0,angle:0,strokeDashArray:"dash"==a?[10,5]:"dot"==a?[5,5]:[0,0],fill:c,strokeWidth:parseInt(b),stroke:0==b||$(this.lineColorEl).hasClass("none")?this.colorEl.style.backgroundColor:this.lineColorEl.style.backgroundColor})},line:function(){var a=this.styleEl.style.val(),b=parseInt(this.styleEl.size.val(),10);return new fabric.Line([this.origX,this.origY,this.origX,this.origY],{strokeWidth:parseInt(b),stroke:this.lineColorEl.style.backgroundColor,strokeDashArray:"dash"==a?[10,5]:"dot"==a?[5,5]:[0,0],originX:"left",originY:"top"})}},function(a){a.MarkerBrush=a.util.createClass(a.PencilBrush,{color:"#000000",opacity:1,width:30,_baseWidth:10,_lastPoint:null,_lineWidth:3,_size:0,initialize:function(a,b){b=b||{},this.canvas=a,this._points=[],this.width=b.width||a.freeDrawingBrush.width,this.color=b.color||a.freeDrawingBrush.color,this.opacity=b.opacity||a.contextTop.globalAlpha,this.canvas.contextTop.lineJoin="round",this.canvas.contextTop.lineCap="round"},onMouseDown:function(a){this._prepareForDrawing(a),this._captureDrawingPath(a),this._lastPoint=a,this.canvas.contextTop.strokeStyle=this.color,this.canvas.contextTop.lineWidth=this._lineWidth,this._size=this.width+this._baseWidth,this._render(a)},onMouseMove:function(a){this.canvas._isCurrentlyDrawing&&(this._captureDrawingPath(a),this._render(a))},onMouseUp:function(){this.canvas.contextTop.globalAlpha=this.opacity,this._finalizeAndAddPath()},changeColor:function(a){this.color=a},changeOpacity:function(a){this.opacity=a},_render:function(b){var c,d,e=this.canvas.contextTop,f=this.canvas.viewportTransform;this._points[0],this._points[1];for(e=this.canvas.contextTop,e.save(),e.transform(f[0],f[1],f[2],f[3],f[4],f[5]),e.beginPath(),c=0,d=this._size/this._lineWidth/2;c<d;c++){var g=(this._lineWidth-1)*c;e.globalAlpha=.3*this.opacity,e.moveTo(this._lastPoint.x+g,this._lastPoint.y+g),e.lineTo(b.x+g,b.y+g),e.stroke()}e.restore(),this._lastPoint=new a.Point(b.x,b.y)},convertPointsToSVGPath:function(b){var c,d=[],e=(this.width,new a.Point(b[0].x,b[0].y)),f=new a.Point(b[1].x,b[1].y),g=b.length;for(c=1;c<g;c++){for(var h=0,i=this._size/this._lineWidth/2;h<i;h++){var j=(this._lineWidth-1)*h;d.push("M ",e.x+j," ",e.y+j," "),d.push("L ",f.x+j," ",f.y+j," ")}e=b[c],c+1<b.length&&(f=b[c+1])}return d},createPath:function(b){var c=new a.Path(b,{fill:null,stroke:this.color,strokeWidth:this._lineWidth,strokeLineCap:this.strokeLineCap,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray,opacity:.8*this.opacity}),d=new a.Point(c.left+c.width/2,c.top+c.height/2);return d=c.translateToGivenOrigin(d,"center","center",c.originX,c.originY),c.top=d.y,c.left=d.x,this.shadow&&(this.shadow.affectStroke=!0,c.setShadow(this.shadow)),c}}),a.Point.prototype.normalize=function(a){null!==a&&void 0!==a||(a=1);var b=this.distanceFrom({x:0,y:0});return b>0&&(this.x=this.x/b*a,this.y=this.y/b*a),this},a.util.getRandom=function(a,b){return b=b||0,Math.random()*((a||1)-b)+b},a.util.clamp=function(a,b,c){return"number"!=typeof c&&(c=0),a>b?b:a<c?c:a},a.CrayonBrush=a.util.createClass(a.SprayBrush,{_baseWidth:2,_inkAmount:10,_latestStrokeLength:0,_point:null,_sep:2,_size:0,useIMAGE:!0,onMouseDown:function(a){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._size=this.width/2*this._baseWidth,this.set(a),this._setShadow()},onMouseMove:function(a){this.update(a),this.addSprayChunk(a),this.render()},onMouseUp:function(){var b=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var c=[],d=this,e=0,f=this.sprayChunks.length;e<f;e++)for(var g=this.sprayChunks[e],h=0,i=g.length;h<i;h++){var j={width:g[h].width,height:g[h].height,left:g[h].x,top:g[h].y,originX:"center",originY:"center",fill:this.color},k=new a.Rect(j);k.setCustomImageSmoothing=d._main.setImageSmoothing,k._CustomRender=k.render,k.render=function(a){this.setCustomImageSmoothing(a,!1),this._CustomRender(a),this.setCustomImageSmoothing(a)},this.shadow&&k.setShadow(this.shadow),c.push(k)}this.optimizeOverlapping&&(c=this._getOptimizedRects(c));var l=new a.Group(c,{originX:"center",originY:"center"});if(l.setCustomImageSmoothing=d._main.setImageSmoothing,l._CustomRender=l.render,l.render=function(a){this.setCustomImageSmoothing(a,!1),this._CustomRender(a),this.setCustomImageSmoothing(a)},l.set({left:Math.ceil(l.left),top:Math.ceil(l.top)}),this.useIMAGE){var m=l.toDataURL("png");a.Image.fromURL(m,function(a){a.left=l.left,a.top=l.top,a.setCustomImageSmoothing=d._main.setImageSmoothing,a._CustomRender=a.render,a.render=function(a){this.setCustomImageSmoothing(a,!1),this._CustomRender(a),this.setCustomImageSmoothing(a)},d.canvas.add(a),d.canvas.fire("path:created",{path:a}),d.canvas.clearContext(d.canvas.contextTop),d._resetShadow(),d.canvas.renderOnAddRemove=b,d.canvas.requestRenderAll()},{originX:"center",originY:"center"})}else l.canvas=this.canvas,this.canvas.add(l),this.canvas.fire("path:created",{path:l}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=b,this.canvas.requestRenderAll()},set:function(b){null==this._point&&(this._point=new a.Point(0,0)),this._latest?this._latest.setFromPoint(this._point):this._latest=new a.Point(b.x,b.y),a.Point.prototype.setFromPoint.call(this._point,b)},update:function(a){this.set(a),this._latestStrokeLength=this._point.subtract(this._latest).distanceFrom({x:0,y:0})},render:function(){var a=this.canvas.contextTop;a.fillStyle=this.color;var b,c,d=this.canvas.viewportTransform;for(a.save(),a.transform(d[0],d[1],d[2],d[3],d[4],d[5]),b=0,c=this.sprayChunkPoints.length;b<c;b++){var e=this.sprayChunkPoints[b];void 0!==e.opacity&&(a.globalAlpha=e.opacity),a.fillRect(e.x,e.y,e.width,e.height)}a.restore()},addSprayChunk:function(b){this.sprayChunkPoints=[];var c,d,e,f=(this.width,this._point.subtract(this._latest)),g=Math.ceil(this._size/2),h=Math.floor(f.distanceFrom({x:0,y:0})/g)+1;f.normalize(g);for(var i=this._sep*a.util.clamp(this._inkAmount/this._latestStrokeLength*3,1,.5),j=Math.ceil(this._size*this._sep),k=this._size/2,e=0;e<j;e++)for(var l=0;l<h;l++){var m=this._latest.add(f.multiply(l)),n=a.util.getRandom(k),o=a.util.getRandom(2*Math.PI),p=a.util.getRandom(i,i/2),q=a.util.getRandom(i,i/2),c=m.x+n*Math.sin(o)-p/2,d=m.y+n*Math.cos(o)-q/2,r=new a.Point(c,d);r.width=p,r.height=q,this.randomOpacity&&(r.opacity=a.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(r)}this.sprayChunks.push(this.sprayChunkPoints)}})}(fabric),DrawTools.prototype={initialize:function(a){function b(a){var b=(f.width()-5)/30,c=1==a?0:b*a;h.text(a),i.val(a),g.css("left",c+"px"),e.changeBrushSize()}function c(a){if(0!=a.clientX&&!(Math.abs(e.origX-a.clientX)<3)){var b,c,d=f.offset().left,j=f.offset().left+f.width()-5,k=(g.position().left,(f.width()-5)/30);b=a.clientX<=d?0:a.clientX>=j?f.width()-5:a.clientX-d,b=parseInt(b,10),c=parseInt(Math.round(b/k),10),c++,c=c>30?30:c,h.text(c),i.val(c),g.css("left",b+"px"),e.changeBrushSize()}}var d=a||{},e=this;this.main=d.main,this.styleEl=d.styleEl||{};var f=this.styleEl.brush_size,g=this.styleEl.wrap_size,h=this.styleEl.size_text,i=this.styleEl.size_input;this.styleEl.pencil&&this.styleEl.pencil.on("click",function(){$(this).hasClass("on")||e.changeType("pencil",$(this).attr("title"))}),this.styleEl.pen&&this.styleEl.pen.on("click",function(){$(this).hasClass("on")||e.changeType("pen",$(this).attr("title"))}),this.styleEl.brush&&this.styleEl.brush.on("click",function(){$(this).hasClass("on")||e.changeType("brush",$(this).attr("title"))}),this.styleEl.color&&e.styleEl.color[0].jscolor&&(e.styleEl.color[0].jscolor.eventChangeValue=function(a,b){e.changeColor()}),this.styleEl.color&&this.styleEl.color.on("click",function(a){this.jscolor&&this.jscolor.show()}),this.styleEl.color_span&&this.styleEl.color_span.on("click",function(a){e.styleEl.color[0].jscolor&&e.styleEl.color[0].jscolor.show()}),this.styleEl.drag_objs&&this.styleEl.drag_objs.on("mousedown",function(a){return e.slider=!0,e.origX=a.clientX,e.origY=a.clientY,!1}),i.on("keyup",function(){var a=parseInt(this.value,10);if(isNaN(a)&&(this.value=""),""==this.value)return!0;a>30?this.value="30":a<1&&(this.value="1"),a=parseInt(this.value,10),b(a)}),i.on("blur",function(){var a=parseInt(this.value,10);isNaN(a)?this.value="1":a>30?this.value="30":a<1&&(this.value="1"),a=parseInt(this.value,10),b(a)}),$(window).on("mousemove",function(a){e.slider&&c(a)}),$(window).on("mouseup",function(){e.slider=!1}),b(5),this.createBrush(),this.changeBrushSize(),this.changeColor(),this.isDown=!1,this.type="pencil",this.lineWidth=null,this.lineStyle=null,this.lineColor=null,this.bgColor=null,this.origX=null,this.origY=null,this.activeObject=null},createHandler:function(){this.activeTools=!0,this.main.canvas.selection=!1,this.main.img&&this.main.img.hoverCursor&&(this.main.img.hoverCursor="crosshair"),this.main.canvas.isDrawingMode=!0},removeHandler:function(){this.activeTools&&(this.activeTools=!1,this.main.img&&this.main.img.hoverCursor&&(this.main.img.hoverCursor="default"),this.main.canvas.isDrawingMode=!1,this.main.canvas.selection=!0)},changeType:function(a,b){$(this.styleEl.main).removeClass("btn_"+this.type),this.styleEl[this.type].removeClass("on"),this.type=a,this.styleEl[this.type].addClass("on"),$(this.styleEl.main).addClass("btn_"+this.type).attr("title",b),this.createBrush()},changeColor:function(){var a=this.styleEl.color_span[0].style.backgroundColor;this.main.canvas.freeDrawingBrush.color=a,this.main.canvas.freeDrawingBrush.changeColor&&this.main.canvas.freeDrawingBrush.changeColor(a)},changeBrushSize:function(){this.main.canvas.freeDrawingBrush.width=this.lineWidth=parseInt(this.styleEl.size_input.val(),10)||1},getPosition:function(a){var b=canvas.getPointer(a.e);return{x:b.x,y:b.y}},createBrush:function(){switch(this.type){case"pencil":this.pencil();break;case"pen":this.pen();break;case"brush":this.brush()}},pencil:function(){var a=new fabric.PencilBrush(this.main.canvas);this.main.canvas.freeDrawingBrush=a,this.changeColor(),this.changeBrushSize()},pen:function(){this.changeColor(),this.changeBrushSize();var a=new fabric.MarkerBrush(this.main.canvas,{width:this.main.canvas.freeDrawingBrush.width,color:this.main.canvas.freeDrawingBrush.color});this.main.canvas.freeDrawingBrush=a},brush:function(){var a=new fabric.CrayonBrush(this.main.canvas,{});a._main=this.main,this.main.canvas.freeDrawingBrush=a,this.changeColor(),this.changeBrushSize()}},CropTools.prototype={initialize:function(a){var b=this,c=a||{};this.ROTATION_BUTTON_AREA=0,this.LR_MARGIN=200,this.TB_MARGIN=40,this.main=c.main,this.styleEl=c.styleEl||{},this.canvas=this.main.crop_canvas,this.canvas.selectable=!1,this.bgImage=this.styleEl.image,this.selector=this.styleEl.selector,this.image=null,this.imageOriginBound=null,this.imageBound=null,this.cropBound={top:0,left:0,width:0,height:0},this.bgImageBound=null,this.processing=null;var d={lt:{m:"xy"},mt:{m:"y"},rt:{m:"xy"},lm:{m:"x"},rm:{m:"x"},lb:{m:"xy"},mb:{m:"y"},rb:{m:"xy"}};this.canvas.clipTo=function(a){b.clipTo(a)},this.cropAction=null,this._guide={resize:$(".resize_guide",this.selector),rotation:$(".rotation_guide",this.selector)},$(window).on("mousemove",function(a){if(b.cropAction){var c=b.cropAction;c.ox=a.pageX-c.x,c.oy=a.pageY-c.y,"pos"!=c.type?b.crop(a):b.move(a),a.preventDefault(),a.stopPropagation()}}),$(window).on("mouseup",function(a){if(b.cropAction){var c=b.cropAction;c.rx=b.cropBound.width/b.cropBound.height,c.ry=b.cropBound.height/b.cropBound.width,"pos"!=c.type&&b.resizeCropZone(a),b.bgImage.css("transition-duration","0.25s"),b._guide[b.cropAction.guide].removeClass("enabled"),b.bgImage.removeClass("enabled"),b.cropAction=null,a.preventDefault(),a.stopPropagation()}}),$(".selector",this.selector).on("mousedown",function(a){var c=$(this).attr("crop_type");b.cropAction={type:c,info:d[c],guide:"resize",x:a.pageX,y:a.pageY,rx:b.cropBound.width/b.cropBound.height,ry:b.cropBound.height/b.cropBound.width},b._guide[b.cropAction.guide].addClass("enabled"),b.bgImage.addClass("enabled"),a.preventDefault(),a.stopPropagation()}),$(this.selector).on("mousedown",function(a){b.cropAction={type:"pos",guide:"resize",x:a.pageX,y:a.pageY,rx:b.cropBound.width/b.cropBound.height,ry:b.cropBound.height/b.cropBound.width},b._guide[b.cropAction.guide].addClass("enabled"),b.bgImage.addClass("enabled"),a.preventDefault(),a.stopPropagation()})},createHandler:function(){var a=this;this.activeTools=!0,this._initSize=!1;var b=this.main.canvas.toDataURL("png");this.main.showPanel("crop"),this.main.setCropCanvasSize(),this.bgImage.attr("src",b),this.canvas.clear().renderAll(),this.canvas.setBackgroundImage(b,function(){var b=a.canvas.backgroundImage;a.image=b,a.imageOriginBound=b.getBoundingRect(),b.hasControls=!1,b.hasBorder=!1,b.selectable=!1,a.canvas.add(b),a.initCalculateSize(),a.canvas.selectable=!1},{originX:"center",originY:"center",selectable:!1})},removeHandler:function(a){this.activeTools&&(this.activeTools=!1,this.apply(a),this.canvas.clear().renderAll(),this.main.showPanel("canvas"))},apply:function(a){var b=this,c=(b.selector,b.image);c.setCoords();var d=c.getBoundingRect(!0,!0),e=b.cropBound;c.scaleX=c.scaleY=1,c.setCoords();var f=c.getBoundingRect(!0,!0);b.canvas.renderAll();var g=1,h=0,i=0;g=f.width/d.width,h=e.width*g-e.width,i=e.height*g-e.height;var j={width:e.width+h,height:e.height+i,top:d.top+(e.top-d.top)*g,left:d.left+(e.left-d.left)*g},k={scale_width:f.width-d.width,scale_height:f.height-d.height};k.offset_top=k.scale_height/2*-1,k.offset_left=k.scale_width/2*-1,j.top+=k.offset_top-f.top,j.left+=k.offset_left-f.left,j.left=Math.round(j.left),j.top=Math.round(j.top),j.width=Math.round(j.width),j.height=Math.round(j.height),b.cropBound=null,b.canvas.renderAll(),this.main.loadData(c.toDataURL({format:"png",left:j.left,top:j.top,width:j.width,height:j.height}),a)},resize:function(){this.activeTools&&this.resizeCropZone()},clipTo:function(a){this.cropBound&&a.rect(this.cropBound.left,this.cropBound.top,this.cropBound.width,this.cropBound.height)},crop:function(a){function b(a){var b,c,d=!1;return"lm"==g.type||"lt"==g.type||"lb"==g.type?(Math.round(h.left+a)<Math.round(f.imageBound.left)&&(a=f.imageBound.left-h.left,d=!0),h.width-a<24&&(a=h.width-24,d=!0),b=-1*a,c=a):(f.imageBound.left+f.imageBound.width<=h.left+h.width+a&&(a=f.imageBound.left+f.imageBound.width-(h.left+h.width),d=!0),h.width+a<24&&(a=24-h.width,d=!0),b=a,c=null),{offset:b,pos:c,oo:("rt"==g.type||"lb"==g.type?-1:1)*a,limit:d}}function c(a){var b,c,d=!1;return"mt"==g.type||"lt"==g.type||"rt"==g.type?(Math.round(h.top+a)<Math.round(f.imageBound.top)&&(a=f.imageBound.top-h.top,d=!0),h.height-a<24&&(a=h.height-24,d=!0),b=-1*a,c=a):(f.imageBound.top+f.imageBound.height<=h.top+h.height+a&&(a=f.imageBound.top+f.imageBound.height-(h.top+h.height),d=!0),h.height+a<24&&(a=24-h.height,d=!0),b=a,c=null),{offset:b,pos:c,oo:("rt"==g.type||"lb"==g.type?-1:1)*a,limit:d}}var d,e,f=this,g=f.cropAction,h=f.cropBound;if("xy"==g.info.m){Math.abs(g.ox)>=Math.abs(g.oy)?(d=b(g.ox),e=c(g.ry*d.oo)):(e=c(g.oy),d=b(g.rx*e.oo)),d.limit&&e.limit?d.offset<e.offset?d=b(g.rx*e.oo):e=c(g.ry*d.oo):d.limit?e=c(g.ry*d.oo):e.limit&&(d=b(g.rx*e.oo))}else"x"==g.info.m?d=b(g.ox):"y"==g.info.m&&(e=c(g.oy));d&&d.limit||e&&e.limit||(g.x=a.pageX,g.y=a.pageY),d&&(h.width+=d.offset,d.pos&&(h.left+=d.pos)),e&&(h.height+=e.offset,e.pos&&(h.top+=e.pos)),f.selector.width(h.width).height(h.height).css({top:h.top-2+"px",left:h.left-2+"px"}),f.canvas.requestRenderAll()},move:function(a){var b=this,c=b.cropAction,d=b.cropBound,e=b.imageBound,f=b.image,g=b.bgImage,h=b.bgImageBound,i=!1,j=!1,k=c.ox,l=c.oy;(e.top+l>d.top||e.height+e.top+l<=d.top+d.height)&&(j=!0,l=0),(e.left+k>d.left||e.width+e.left+k<=d.left+d.width)&&(i=!0,k=0),f.top+=l,f.left+=k,h.translateX+=k,h.translateY+=l,g.css("transition-duration","0s"),g.css("transform","translate("+h.translateX+"px, "+h.translateY+"px) scaleX("+h.scale+") scaleY("+h.scale+") rotate("+h.rotate+"rad) translateZ(0px)"),i||(c.x=a.pageX),j||(c.y=a.pageY),f.setCoords();var d=f.getBoundingRect(!0,!0);b.imageBound=$.extend(!0,{},d),b.canvas.requestRenderAll()},initCalculateSize:function(){var a=this;if(this.image){var b=a.image,c=a.imageOriginBound,d=a.selector,e=a.canvas.getWidth(),f=a.canvas.getHeight(),g=e-this.LR_MARGIN,h=f-this.TB_MARGIN,i=c.width,j=c.height,k=1;k=g/c.width<h/c.height?g/c.width:h/c.height,b.scaleX=b.scaleY=k,b.setCoords(),c=b.getBoundingRect(),b.left=e/2-a.ROTATION_BUTTON_AREA,b.top=f/2;var l=a.bgImageBound={translateX:(e-i)/2-a.ROTATION_BUTTON_AREA,translateY:(f-j)/2,scale:k,rotate:0};a.bgImage.css("transform","translate("+l.translateX+"px, "+l.translateY+"px) scaleX("+l.scale+") scaleY("+l.scale+") rotate("+l.rotate+"rad) translateZ(0px)"),c=b.getBoundingRect(!0,!0),a.imageBound=$.extend(!0,{},c),a.cropBound=$.extend(!0,{},c),d.width(c.width).height(c.height).css({top:c.top-2+"px",left:c.left-2+"px"}),a.canvas.requestRenderAll(),this._initSize=!0}},resizeCropZone:function(a){if(this._initSize){var b=this,c=(b.cropAction,b.selector),d=b.image,e=b.bgImage,f=b.imageOriginBound,g=b.cropBound,h=b.bgImageBound,i=b.imageBound,j=b.canvas.getWidth(),k=b.canvas.getHeight(),l=j-this.LR_MARGIN,m=k-this.TB_MARGIN,n=1,o=0,p=0;n=l/g.width<m/g.height?l/g.width:m/g.height,o=g.width*n-g.width,p=g.height*n-g.height,h.scale*=n;var q={width:g.width+o,height:g.height+p,top:i.top+(g.top-i.top)*n,left:i.left+(g.left-i.left)*n},r={old_width:i.width,old_height:i.height,scale_width:f.width*h.scale-i.width,scale_height:f.height*h.scale-i.height};r.offset_top=r.scale_height/2*-1,r.offset_left=r.scale_width/2*-1,q.top+=r.offset_top,q.left+=r.offset_left;var s=j/2-b.ROTATION_BUTTON_AREA,t=k/2,u=s-(q.left+q.width/2),v=t-(q.top+q.height/2);h.translateX+=u,h.translateY+=v,q.top+=v,q.left+=u,e.css("transition",".25s all ease-in"),c.css("transition",".25s all ease-in"),c.width(q.width).height(q.height).css({top:q.top-2+"px",left:q.left-2+"px"}),e.css("transform","translate("+h.translateX+"px, "+h.translateY+"px) scaleX("+h.scale+") scaleY("+h.scale+") rotate("+h.rotate+"rad) translateZ(0px)"),d.animate({top:d.top+v,left:d.left+u,scaleX:h.scale,scaleY:h.scale},{duration:250,onChange:function(){g.top=parseInt(c.css("top"),10)-1,g.left=parseInt(c.css("left"),10)-1,g.width=parseInt(c.css("width"),10),g.height=parseInt(c.css("height"),10),b.canvas.renderAll()},onComplete:function(){c.css("transition",""),e.css("transition",""),g.top=q.top,g.left=q.left,g.width=q.width,g.height=q.height,d.setCoords();var a=d.getBoundingRect(!0,!0);b.imageBound=$.extend(!0,{},a),b.canvas.renderAll()}})}}};